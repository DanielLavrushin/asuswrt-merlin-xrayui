import{_ as l,a as t,b as o,c as d}from"./20251025013437-C6_y1YdW.js";import{_ as c,c as p,a as e,b as a,e as n,d as r,w as u,r as h,o as m}from"./app-eTybrgsj.js";const g={};function v(b,s){const i=h("RouteLink");return m(),p("div",null,[s[4]||(s[4]=e('<h1 id="руководство-по-правилам-маршрутизации" tabindex="-1"><a class="header-anchor" href="#руководство-по-правилам-маршрутизации"><span>Руководство по правилам маршрутизации</span></a></h1><p>Правила маршрутизации являются ядром системы управления трафиком Xray. Они определяют, какое исходящее соединение (исходящий прокси (<code>vless</code>/<code>vmess</code>/<code>xhttp</code> и т.д.), прямое соединение (<code>freedom</code>) или блокировка (<code>blackhole</code>)) должно обрабатывать конкретный трафик на основе различных критериев, таких как домены, IP-адреса, порты и протоколы.</p><h2 id="архитектура-потока-трафика" tabindex="-1"><a class="header-anchor" href="#архитектура-потока-трафика"><span>Архитектура потока трафика</span></a></h2><p>Прежде чем погружаться в правила маршрутизации, крайне важно понимать, что <strong>не весь трафик автоматически проходит через Xray</strong>. Модуль XRAYUI реализует многоуровневую систему управления трафиком:</p><h3 id="уровень-1-перехват-на-системном-уровне" tabindex="-1"><a class="header-anchor" href="#уровень-1-перехват-на-системном-уровне"><span>Уровень 1: Перехват на системном уровне</span></a></h3><p>Сначала роутер решает, какой трафик перехватывать, основываясь на вашей базовой конфигурации:</p>',6)),a("ul",null,[a("li",null,[a("strong",null,[r(i,{to:"/ru/br-policy.html"},{default:u(()=>s[0]||(s[0]=[n("Политики обхода/перенаправления",-1)])),_:1,__:[0]})]),s[1]||(s[1]=n(" определяют, какие устройства и порты обрабатываются",-1))]),s[2]||(s[2]=a("li",null,[a("strong",null,[a("a",{href:"general-options#%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D1%8C-dns-%D0%BE%D0%B1%D1%85%D0%BE%D0%B4-ipset"},"Режим DNS обхода")]),n(" влияет на принятие решений на основе доменов")],-1)),s[3]||(s[3]=a("li",null,"Только перехваченный трафик достигает Xray для обработки",-1))]),s[5]||(s[5]=e(`<h3 id="уровень-2-разрешение-dns-и-обход" tabindex="-1"><a class="header-anchor" href="#уровень-2-разрешение-dns-и-обход"><span>Уровень 2: Разрешение DNS и обход</span></a></h3><p>Перед оценкой правил маршрутизации Xray функция <strong>DNS обхода/перенаправления</strong> может принимать решения о маршрутизации.</p><p>Изначально модуль отлавливает любой трафик (ну почти, но это не важно в данном случае) и перенаправляет на инбаунд порт докодемо иксрея. Как позже выяснилось, при больших нагрузках иксрею тяжко в немощных роутерах справляться с таким потоком.</p><h4 id="режимы-dns-обхода" tabindex="-1"><a class="header-anchor" href="#режимы-dns-обхода"><span>Режимы DNS обхода</span></a></h4><ul><li><p><strong>OFF</strong>: Весь перехваченный трафик идёт в Xray для маршрутизации на основе правил</p></li><li><p><strong>BYPASS</strong>: Вычленяет все правила из конфига, что указаны в тип аутбаунда <code>FREEDOM</code> и по сути любой трафик на эти домены не будет отправляться в иксрей. Например, если вы сделали правило <code>domain:ru</code> в FREEDOM - таким образом любой трафик на домены .ru не будет кидаться в иксрей, а будет ходить будто и нет никакого иксрея на роутере. Остальной трафик проходит через Xray.</p></li><li><p><strong>REDIRECT</strong>: Работает обратно байпассу - вычленяет все правила, где тип аутбаунда НЕ FREEDOM и шлет их в иксрей. То есть если вы сделали правило <code>geosite:youtube</code> в аутбаунд proxy, таким образом весь трафик кроме доменов ютуба будет обходить иксрей, а ютуб будет кидаться в иксрей процесс.</p></li></ul><div class="hint-container important"><p class="hint-container-title">Важно</p><p>DNS обход/перенаправление происходит ДО правил маршрутизации Xray! Это маршрутизация трафиком еще до того, как он попадет в процесс иксрея. Важно помнить, что то как и куда там внутри иксрея у вас идет трафик зависит от ваших правил в иксрее, но это скажем так уже другая история.</p></div><div class="hint-container note"><p class="hint-container-title">Заметка</p><p>Важный момент: в категориях геодаты могут (очень редко, но бывает) попадаться <code>regexp:</code> префиксы для доменов. Такие &quot;домены&quot; игнорируются опцией &quot;включить dns-обход&quot; и работать не будут, но это скажем так маленькая проблема.</p></div><h3 id="уровень-3-правила-маршрутизации-xray" tabindex="-1"><a class="header-anchor" href="#уровень-3-правила-маршрутизации-xray"><span>Уровень 3: Правила маршрутизации Xray</span></a></h3><p>Только трафик, который проходит через предыдущие уровни, достигает механизма маршрутизации Xray, где ваши правила оцениваются последовательно.</p><h2 id="понимание-префиксов-доменов" tabindex="-1"><a class="header-anchor" href="#понимание-префиксов-доменов"><span>Понимание префиксов доменов</span></a></h2><p>Маршрутизация доменов в Xray обеспечивает гибкое управление трафиком через различные подходы к сопоставлению. Понимание этих префиксов необходимо для эффективного создания правил.</p><h3 id="базовое-сопоставление-доменов" tabindex="-1"><a class="header-anchor" href="#базовое-сопоставление-доменов"><span>Базовое сопоставление доменов</span></a></h3><p>Префикс <code>domain:</code> является основой маршрутизации на основе доменов:</p><ul><li><p><strong><code>domain:com</code></strong> — Соответствует ВСЕМ доменам верхнего уровня .com и их поддоменам</p><ul><li>✅ Соответствует: <code>dmn.com</code>, <code>example.com</code>, <code>sub.example.com</code></li><li>❌ Не соответствует: <code>us.com</code>, <code>us-server.net</code></li></ul></li><li><p><strong><code>domain:dmn.com</code></strong> — Соответствует домену и всем его поддоменам</p><ul><li>✅ Соответствует: <code>dmn.com</code>, <code>www.dmn.com</code>, <code>some.sub.domain.dmn.com</code></li><li>❌ Не соответствует: <code>domains.com</code>, <code>notdmn.com</code></li></ul></li><li><p><strong><code>domain:www.dmn.com</code></strong> — Соответствует только этому конкретному поддомену и его под-поддоменам</p><ul><li>✅ Соответствует: <code>www.dmn.com</code>, <code>api.www.dmn.com</code></li><li>❌ Не соответствует: <code>dmn.com</code>, <code>m.dmn.com</code></li></ul></li></ul><h3 id="полное-сопоставление-доменов" tabindex="-1"><a class="header-anchor" href="#полное-сопоставление-доменов"><span>Полное сопоставление доменов</span></a></h3><p>Используйте <code>full:</code> когда вам нужно точное сопоставление домена без поддоменов:</p><ul><li><strong><code>full:google.com</code></strong> — Соответствует ТОЛЬКО <code>google.com</code><ul><li>✅ Соответствует: <code>google.com</code></li><li>❌ Не соответствует: <code>www.google.com</code>, <code>maps.google.com</code></li></ul></li></ul><h3 id="сопоставление-по-шаблону" tabindex="-1"><a class="header-anchor" href="#сопоставление-по-шаблону"><span>Сопоставление по шаблону</span></a></h3><p>Для более гибкого сопоставления используйте ключевые слова и шаблоны регулярных выражений:</p><ul><li><p><strong><code>keyword:google</code></strong> — Соответствует любому домену, содержащему &quot;google&quot;</p><ul><li>✅ Соответствует: <code>google.com</code>, <code>googleusercontent.com</code>, <code>mygooglesite.net</code></li></ul></li><li><p><strong><code>regexp:.*\\.edu$</code></strong> — Соответствует доменам, заканчивающимся на .edu, используя регулярные выражения</p><ul><li>✅ Соответствует: <code>harvard.edu</code>, <code>mit.edu</code></li><li>❌ Не соответствует: <code>education.com</code></li></ul></li></ul><h2 id="работа-с-базами-данных-geosite" tabindex="-1"><a class="header-anchor" href="#работа-с-базами-данных-geosite"><span>Работа с базами данных Geosite</span></a></h2><p>Для эффективного управления большими коллекциями доменов Xray поддерживает файлы geosite. Это поддерживаемые сообществом базы данных, которые группируют сотни или тысячи связанных доменов под одним тегом.</p><h3 id="зачем-использовать-geosite" tabindex="-1"><a class="header-anchor" href="#зачем-использовать-geosite"><span>Зачем использовать Geosite?</span></a></h3><p>Вместо ручного перечисления десятков доменов для сервиса вроде YouTube:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">domain:youtube.com</span>
<span class="line">domain:youtube.ru</span>
<span class="line">domain:youtu.be</span>
<span class="line">domain:youtubeeducation.com</span>
<span class="line">domain:youtube-nocookie.com</span>
<span class="line">domain:googleapis.com</span>
<span class="line"># ... и многие другие</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Вы можете просто использовать:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">geosite:youtube</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Это автоматически включает ВСЕ домены, связанные с YouTube, из базы данных сообщества, включая CDN, конечные точки API и региональные варианты.</p><h3 id="доступные-категории-geosite" tabindex="-1"><a class="header-anchor" href="#доступные-категории-geosite"><span>Доступные категории Geosite</span></a></h3><p>Сообщество поддерживает обширные списки доменов. Вы можете найти все доступные категории на: <a href="https://github.com/v2fly/domain-list-community/tree/master/data" target="_blank" rel="noopener noreferrer">GitHub: v2fly/domain-list-community</a></p><p>Общие категории включают:</p><ul><li><code>geosite:google</code> — Все сервисы Google</li><li><code>geosite:youtube</code> — YouTube и связанные домены</li><li><code>geosite:netflix</code> — Стриминговый сервис Netflix</li><li><code>geosite:telegram</code> — Мессенджер Telegram</li><li><code>geosite:facebook</code> — Facebook и Instagram</li><li><code>geosite:twitter</code> — Платформа Twitter/X</li><li><code>geosite:cn</code> — Китайские веб-сайты</li><li><code>geosite:category-media-ru</code> - Все заблокированные медиа в России</li><li><code>geosite:category-ads-all</code> — Рекламные сети</li><li><code>geosite:geolocation-!cn</code> — Не китайские сайты</li></ul><h3 id="понимание-содержимого-категории" tabindex="-1"><a class="header-anchor" href="#понимание-содержимого-категории"><span>Понимание содержимого категорий</span></a></h3><p>Давайте рассмотрим, как работают категории на простом примере:</p><p>Категория <code>geosite:actalis</code> содержит всего два домена:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">domain:actalis.com</span>
<span class="line">domain:actalis.it</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Когда вы используете <code>geosite:actalis</code>, это эквивалентно добавлению обоих доменов вручную. Однако ключевое преимущество — <strong>автоматические обновления</strong> — если сообщество добавит новые домены Actalis в будущем, ваши правила автоматически включат их при обновлении базы данных geosite.</p><h3 id="вклад-сообщества" tabindex="-1"><a class="header-anchor" href="#вклад-сообщества"><span>Вклад сообщества</span></a></h3><p>База данных geosite поддерживается сообществом. Например, категория <code>category-media-ru</code> была недавно добавлена:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">geosite:category-media-ru</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Теперь это автоматически включает все домены, связанные с category-media-ru, без необходимости перечислять их индивидуально.</p><h3 id="создание-пользовательских-категории-geosite" tabindex="-1"><a class="header-anchor" href="#создание-пользовательских-категории-geosite"><span>Создание пользовательских категорий Geosite</span></a></h3><p>Вы можете создавать свои собственные списки доменов, используя функцию пользовательского geosite в xrayui: Подробнее читайте о <a href="/en/custom-geodata" target="_blank" rel="noopener noreferrer">пользовательских файлах geosite dat</a>.</p><h3 id="обновление-баз-данных-geosite" tabindex="-1"><a class="header-anchor" href="#обновление-баз-данных-geosite"><span>Обновление баз данных Geosite</span></a></h3><p>Базы данных geosite сообщества регулярно обновляются новыми доменами и категориями. Чтобы поддерживать точность маршрутизации:</p><h4 id="ручное-обновление" tabindex="-1"><a class="header-anchor" href="#ручное-обновление"><span>Ручное обновление</span></a></h4><ol><li>Перейдите в раздел <strong>Routing</strong></li><li>Нажмите кнопку <strong>Update community files</strong></li><li>Дождитесь завершения обновления</li><li>Примените конфигурацию</li></ol><h4 id="автоматические-обновления" tabindex="-1"><a class="header-anchor" href="#автоматические-обновления"><span>Автоматические обновления</span></a></h4><ol><li>Перейдите в <strong>General Options</strong> → вкладка <strong>Geodata</strong></li><li>Включите <strong>Auto-update geodata files</strong></li><li>Обновления будут происходить ночью в 03:00</li></ol><div class="hint-container tip"><p class="hint-container-title">Совет</p><p>Регулярные обновления гарантируют, что ваши правила будут захватывать недавно добавленные домены для сервисов, таких как стриминговые платформы, которые часто добавляют новые конечные точки CDN.</p></div><h3 id="проверка-содержимого-geosite" tabindex="-1"><a class="header-anchor" href="#проверка-содержимого-geosite"><span>Проверка содержимого Geosite</span></a></h3><p>Чтобы увидеть, какие домены включены в категорию geosite:</p><ol><li>Проверьте <a href="https://github.com/v2fly/domain-list-community/tree/master/data" target="_blank" rel="noopener noreferrer">официальный репозиторий</a></li><li>Найдите файл категории (например, <code>youtube</code>)</li><li>Просмотрите включенные домены и шаблоны</li></ol><p>Это поможет вам понять, какой именно трафик будет соответствовать вашим правилам.</p><h2 id="понимание-правил-маршрутизации" tabindex="-1"><a class="header-anchor" href="#понимание-правил-маршрутизации"><span>Понимание правил маршрутизации</span></a></h2><p>В <code>XRAYUI</code> правила маршрутизации работают как <strong>последовательное дерево решений</strong>. Когда поступает трафик, Xray оценивает правила сверху вниз и применяет <strong>первое совпадающее правило</strong>. Если ни одно правило не совпадает, используется поведение по умолчанию.</p><div class="hint-container important"><p class="hint-container-title">Важно</p><p>Порядок правил важен! Правила оцениваются последовательно, поэтому более конкретные правила обычно должны идти перед более общими.</p></div><h2 id="интерфеис-правил" tabindex="-1"><a class="header-anchor" href="#интерфеис-правил"><span>Интерфейс правил</span></a></h2><p>Для управления правилами маршрутизации в <code>XRAYUI</code>:</p><ol><li>Перейдите в раздел <strong>Routing</strong> на главной странице <img src="`+l+'" alt=""></li><li>Нажмите кнопку <strong>Manage</strong> рядом с <strong>Rules</strong></li><li>Откроется окно менеджера правил <img src="'+t+'" alt=""></li></ol><h2 id="добавление-нового-правила" tabindex="-1"><a class="header-anchor" href="#добавление-нового-правила"><span>Добавление нового правила</span></a></h2><h3 id="шаг-1-откроите-редактор-правил" tabindex="-1"><a class="header-anchor" href="#шаг-1-откроите-редактор-правил"><span>Шаг 1: Откройте редактор правил</span></a></h3><p>Нажмите <strong>Add new rule</strong> внизу окна менеджера правил.</p><h3 id="шаг-2-настроите-базовые-параметры" tabindex="-1"><a class="header-anchor" href="#шаг-2-настроите-базовые-параметры"><span>Шаг 2: Настройте базовые параметры</span></a></h3><table><thead><tr><th>Поле</th><th>Описание</th><th>Пример</th></tr></thead><tbody><tr><td><strong>Friendly Name</strong></td><td>Необязательное описательное имя правила</td><td>&quot;Netflix to Proxy&quot;</td></tr><tr><td><strong>Outbound connection</strong></td><td>Какое исходящее использовать при совпадении</td><td>proxy, direct, block</td></tr><tr><td><strong>Enabled</strong></td><td>Включить/выключить правило без удаления</td><td>✓ (отмечено)</td></tr></tbody></table><h3 id="шаг-3-определите-критерии-соответствия" tabindex="-1"><a class="header-anchor" href="#шаг-3-определите-критерии-соответствия"><span>Шаг 3: Определите критерии соответствия</span></a></h3><p><img src="'+o+`" alt=""></p><p>Правила могут соответствовать трафику на основе нескольких критериев:</p><h4 id="домены" tabindex="-1"><a class="header-anchor" href="#домены"><span>Домены</span></a></h4><p>Введите домены для соответствия, по одному на строку. Поддерживает несколько форматов:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># Точный домен и поддомены</span>
<span class="line">domain:google.com</span>
<span class="line"></span>
<span class="line"># Только точное совпадение</span>
<span class="line">full:www.google.com</span>
<span class="line"></span>
<span class="line"># Сопоставление по ключевому слову</span>
<span class="line">keyword:facebook</span>
<span class="line"></span>
<span class="line"># Регулярное выражение</span>
<span class="line">regexp:.*\\.gov$</span>
<span class="line"></span>
<span class="line"># Базы данных Geosite</span>
<span class="line">geosite:netflix</span>
<span class="line">geosite:category-ads</span>
<span class="line">ext:xrayui:streaming</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">Совет</p><p>Используйте кнопки <strong>geosite:</strong> и <strong>ext:xrayui:</strong> над полем домена для быстрой вставки префикса. Функция автозаполнения поможет вам найти доступные теги.</p></div><h4 id="ip-адреса" tabindex="-1"><a class="header-anchor" href="#ip-адреса"><span>IP-адреса</span></a></h4><p>Укажите IP-адреса или диапазоны CIDR:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># Один IP</span>
<span class="line">192.168.1.1</span>
<span class="line"></span>
<span class="line"># Диапазон CIDR</span>
<span class="line">192.168.1.0/24</span>
<span class="line"></span>
<span class="line"># Несколько IP/диапазонов</span>
<span class="line">10.0.0.0/8</span>
<span class="line">172.16.0.0/12</span>
<span class="line"></span>
<span class="line"># База данных GeoIP</span>
<span class="line">geoip:cn</span>
<span class="line">geoip:private</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="исходные-ip-адреса" tabindex="-1"><a class="header-anchor" href="#исходные-ip-адреса"><span>Исходные IP-адреса</span></a></h4><p>Соответствовать трафику от конкретных устройств:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">192.168.1.100</span>
<span class="line">192.168.1.0/24</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="порты" tabindex="-1"><a class="header-anchor" href="#порты"><span>Порты</span></a></h4><p>Определите порты назначения:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># Один порт</span>
<span class="line">443</span>
<span class="line"></span>
<span class="line"># Диапазон портов (используйте двоеточие, не дефис)</span>
<span class="line">8080:8090</span>
<span class="line"></span>
<span class="line"># Несколько портов/диапазонов</span>
<span class="line">80</span>
<span class="line">443</span>
<span class="line">8080:8090</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="сети" tabindex="-1"><a class="header-anchor" href="#сети"><span>Сети</span></a></h4><p>Выберите протоколы для соответствия:</p><ul><li><strong>tcp</strong>: Только TCP трафик</li><li><strong>udp</strong>: Только UDP трафик (включая QUIC/HTTP3)</li><li><em>Оставьте пустым для обоих</em></li></ul><h4 id="протоколы" tabindex="-1"><a class="header-anchor" href="#протоколы"><span>Протоколы</span></a></h4><p>Соответствовать конкретным протоколам приложений:</p><ul><li><strong>http</strong>: HTTP трафик</li><li><strong>tls</strong>: HTTPS/TLS трафик</li><li><strong>bittorrent</strong>: Торрент трафик</li><li><strong>quic</strong>: QUIC/HTTP3 трафик</li></ul><div class="hint-container note"><p class="hint-container-title">Заметка</p><p>Обнаружение протоколов работает путем проверки содержимого пакетов, а не только портов.</p></div><h3 id="шаг-4-установите-приоритет-правила" tabindex="-1"><a class="header-anchor" href="#шаг-4-установите-приоритет-правила"><span>Шаг 4: Установите приоритет правила</span></a></h3><p>Используйте кнопки вверх/вниз для изменения порядка правил. Помните: первое совпадающее правило выигрывает!</p><h3 id="шаг-5-сохраните-и-примените" tabindex="-1"><a class="header-anchor" href="#шаг-5-сохраните-и-примените"><span>Шаг 5: Сохраните и примените</span></a></h3><ol><li>Нажмите <strong>Save</strong> в редакторе правил</li><li>Нажмите <strong>Apply</strong> на главной странице для активации изменений</li></ol><h2 id="примеры-правил" tabindex="-1"><a class="header-anchor" href="#примеры-правил"><span>Примеры правил</span></a></h2><h3 id="пример-1-направить-netflix-через-прокси" tabindex="-1"><a class="header-anchor" href="#пример-1-направить-netflix-через-прокси"><span>Пример 1: Направить Netflix через прокси</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Friendly Name</span><span class="token punctuation">:</span> Netflix через прокси</span>
<span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> proxy</span>
<span class="line"><span class="token key atrule">Domains</span><span class="token punctuation">:</span> geosite<span class="token punctuation">:</span>netflix</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="пример-2-блокировать-рекламу" tabindex="-1"><a class="header-anchor" href="#пример-2-блокировать-рекламу"><span>Пример 2: Блокировать рекламу</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Friendly Name</span><span class="token punctuation">:</span> Блокировка рекламы</span>
<span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> block</span>
<span class="line"><span class="token key atrule">Domains</span><span class="token punctuation">:</span> geosite<span class="token punctuation">:</span>category<span class="token punctuation">-</span>ads<span class="token punctuation">-</span>all</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="пример-3-прямое-соединение-для-локальных-сервисов" tabindex="-1"><a class="header-anchor" href="#пример-3-прямое-соединение-для-локальных-сервисов"><span>Пример 3: Прямое соединение для локальных сервисов</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Friendly Name</span><span class="token punctuation">:</span> Локальная сеть прямо</span>
<span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line"><span class="token key atrule">IPs</span><span class="token punctuation">:</span> 192.168.1.0/24</span>
<span class="line">  10.0.0.0/8</span>
<span class="line">  geoip<span class="token punctuation">:</span>private</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="пример-4-направить-https-трафик-конкретного-устроиства" tabindex="-1"><a class="header-anchor" href="#пример-4-направить-https-трафик-конкретного-устроиства"><span>Пример 4: Направить HTTPS трафик конкретного устройства</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Friendly Name</span><span class="token punctuation">:</span> Ноутбук HTTPS через прокси</span>
<span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> proxy</span>
<span class="line"><span class="token key atrule">Source IPs</span><span class="token punctuation">:</span> 192.168.1.100</span>
<span class="line"><span class="token key atrule">Ports</span><span class="token punctuation">:</span> <span class="token number">443</span></span>
<span class="line"><span class="token key atrule">Networks</span><span class="token punctuation">:</span> tcp</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="пример-5-обоити-торрент-трафик" tabindex="-1"><a class="header-anchor" href="#пример-5-обоити-торрент-трафик"><span>Пример 5: Обойти торрент трафик</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Friendly Name</span><span class="token punctuation">:</span> Торренты прямо</span>
<span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line"><span class="token key atrule">Protocols</span><span class="token punctuation">:</span> bittorrent</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="специальные-функции-правил" tabindex="-1"><a class="header-anchor" href="#специальные-функции-правил"><span>Специальные функции правил</span></a></h2><h3 id="системные-правила-только-для-чтения" tabindex="-1"><a class="header-anchor" href="#системные-правила-только-для-чтения"><span>Системные правила (Только для чтения)</span></a></h3><p>Некоторые правила автоматически генерируются системой:</p><ul><li><strong>DNS правила</strong>: Управляют трафиком DNS разрешения</li><li><strong>Правила политик B/R</strong>: Генерируются из ваших настроек обхода/перенаправления</li></ul><p>Эти правила нельзя редактировать напрямую, но их можно отключить.</p><h3 id="группы-правил" tabindex="-1"><a class="header-anchor" href="#группы-правил"><span>Группы правил</span></a></h3><p>Организуйте связанные правила вместе:</p><ol><li>Создайте правила с похожими именами</li><li>Используйте согласованные префиксы имен (например, &quot;Streaming: Netflix&quot;, &quot;Streaming: YouTube&quot;)</li><li>Расположите их последовательно в списке правил</li></ol><h2 id="проверка-и-отладка-правил" tabindex="-1"><a class="header-anchor" href="#проверка-и-отладка-правил"><span>Проверка и отладка правил</span></a></h2><h3 id="используите-правила-логирования" tabindex="-1"><a class="header-anchor" href="#используите-правила-логирования"><span>Используйте правила логирования</span></a></h3><p>Создайте временные правила для тестирования:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Friendly Name</span><span class="token punctuation">:</span> ТЕСТ <span class="token punctuation">-</span> Лог трафика Google</span>
<span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line"><span class="token key atrule">Domains</span><span class="token punctuation">:</span> domain<span class="token punctuation">:</span>google.com</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Включите логирование и наблюдайте, когда это правило срабатывает.</p><h3 id="проверка-порядка-правил" tabindex="-1"><a class="header-anchor" href="#проверка-порядка-правил"><span>Проверка порядка правил</span></a></h3><ol><li>Более конкретные правила первыми</li><li>Региональные блокировки перед общими проксями</li><li>Правила исключений перед catch-all правилами</li></ol><h3 id="использование-инструментов-диагностики" tabindex="-1"><a class="header-anchor" href="#использование-инструментов-диагностики"><span>Использование инструментов диагностики</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Проверка, какое правило соответствует</span></span>
<span class="line"><span class="token function">tail</span> <span class="token parameter variable">-f</span> /tmp/log/xray_access.log</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Мониторинг живого трафика</span></span>
<span class="line">tcpdump <span class="token parameter variable">-i</span> any <span class="token parameter variable">-n</span> <span class="token function">host</span> example.com</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="интеграция-с-другими-функциями" tabindex="-1"><a class="header-anchor" href="#интеграция-с-другими-функциями"><span>Интеграция с другими функциями</span></a></h2><h3 id="dns-обход-и-правила" tabindex="-1"><a class="header-anchor" href="#dns-обход-и-правила"><span>DNS обход и правила</span></a></h3><p><strong>Сценарий</strong>: У вас есть правила для направления Netflix через прокси</p><ul><li>Если DNS обход = BYPASS, Netflix может обойти Xray перед оценкой правила</li><li>Если DNS обход = REDIRECT, только не-FREEDOM трафик достигает ваших правил</li><li>Если DNS обход = OFF, все правила оцениваются нормально</li></ul><h3 id="пользовательские-списки-geosite" tabindex="-1"><a class="header-anchor" href="#пользовательские-списки-geosite"><span>Пользовательские списки Geosite</span></a></h3><p>Вы можете создавать пользовательские категории доменов:</p><ol><li>Перейдите в <strong>Routing</strong> → <strong>Custom geosite dat files</strong></li><li>Создайте новую категорию (например, &quot;mywork&quot;)</li><li>Добавьте домены</li><li>Используйте в правилах: <code>ext:xrayui:mywork</code></li></ol><h3 id="балансировщики-и-резервные-варианты" tabindex="-1"><a class="header-anchor" href="#балансировщики-и-резервные-варианты"><span>Балансировщики и резервные варианты</span></a></h3><p>Правила могут направлять на балансировщики вместо одного исходящего:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Outbound</span><span class="token punctuation">:</span> balancer<span class="token punctuation">-</span>us</span>
<span class="line"><span class="token comment"># Направляет на несколько серверов US с балансировкой нагрузки</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="распространенные-настроики" tabindex="-1"><a class="header-anchor" href="#распространенные-настроики"><span>Распространенные настройки</span></a></h2><h3 id="конфигурация-проксировать-все-кроме-локального" tabindex="-1"><a class="header-anchor" href="#конфигурация-проксировать-все-кроме-локального"><span>Конфигурация &quot;Проксировать всё, кроме локального&quot;</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Правило 1</span><span class="token punctuation">:</span> Локальные IP прямо</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line">  <span class="token key atrule">IPs</span><span class="token punctuation">:</span> geoip<span class="token punctuation">:</span>private</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Правило 2</span><span class="token punctuation">:</span> Китайские сайты прямо</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line">  <span class="token key atrule">Domains</span><span class="token punctuation">:</span> geosite<span class="token punctuation">:</span>cn</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Правило 3</span><span class="token punctuation">:</span> Всё остальное через прокси</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> proxy</span>
<span class="line">  <span class="token comment"># Оставить все критерии пустыми для catch-all</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="конфигурация-только-конкретные-сервисы" tabindex="-1"><a class="header-anchor" href="#конфигурация-только-конкретные-сервисы"><span>Конфигурация &quot;Только конкретные сервисы&quot;</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Правило 1</span><span class="token punctuation">:</span> Стриминговые сервисы</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> proxy</span>
<span class="line">  <span class="token key atrule">Domains</span><span class="token punctuation">:</span></span>
<span class="line">    geosite<span class="token punctuation">:</span>netflix</span>
<span class="line">    geosite<span class="token punctuation">:</span>youtube</span>
<span class="line">    geosite<span class="token punctuation">:</span>twitch</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Правило 2</span><span class="token punctuation">:</span> Всё остальное прямо</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line">  <span class="token comment"># Пустые критерии = catch-all</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="конфигурация-обход-региональных-ограничении" tabindex="-1"><a class="header-anchor" href="#конфигурация-обход-региональных-ограничении"><span>Конфигурация &quot;Обход региональных ограничений&quot;</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">Правило 1</span><span class="token punctuation">:</span> Заблокированные медиа в России</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> proxy</span>
<span class="line">  <span class="token key atrule">Domains</span><span class="token punctuation">:</span> geosite<span class="token punctuation">:</span>category<span class="token punctuation">-</span>media<span class="token punctuation">-</span>ru</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Правило 2</span><span class="token punctuation">:</span> Российские сервисы прямо</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> direct</span>
<span class="line">  <span class="token key atrule">Domains</span><span class="token punctuation">:</span> geosite<span class="token punctuation">:</span>ru</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Правило 3</span><span class="token punctuation">:</span> Международные сервисы</span>
<span class="line">  <span class="token key atrule">Outbound</span><span class="token punctuation">:</span> proxy</span>
<span class="line">  <span class="token key atrule">Domains</span><span class="token punctuation">:</span> geosite<span class="token punctuation">:</span>geolocation<span class="token punctuation">-</span><span class="token tag">!ru</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="список-доступных-тегов-geosite" tabindex="-1"><a class="header-anchor" href="#список-доступных-тегов-geosite"><span>Список доступных тегов Geosite</span></a></h2><h3 id="региональные-категории" tabindex="-1"><a class="header-anchor" href="#региональные-категории"><span>Региональные категории</span></a></h3><ul><li><code>geosite:cn</code> - Китайские домены</li><li><code>geosite:ru</code> - Российские домены</li><li><code>geosite:us</code> - Американские домены</li><li><code>geosite:uk</code> - Британские домены</li><li><code>geosite:jp</code> - Японские домены</li></ul><h3 id="категории-сервисов" tabindex="-1"><a class="header-anchor" href="#категории-сервисов"><span>Категории сервисов</span></a></h3><ul><li><code>geosite:google</code> - Сервисы Google</li><li><code>geosite:youtube</code> - YouTube</li><li><code>geosite:facebook</code> - Facebook &amp; Instagram</li><li><code>geosite:twitter</code> - Twitter/X</li><li><code>geosite:telegram</code> - Telegram</li><li><code>geosite:netflix</code> - Netflix</li><li><code>geosite:spotify</code> - Spotify</li></ul><h3 id="специальные-категории" tabindex="-1"><a class="header-anchor" href="#специальные-категории"><span>Специальные категории</span></a></h3><ul><li><code>geosite:category-ads-all</code> - Все рекламные сети</li><li><code>geosite:category-media-ru</code> - Заблокированные медиа в России</li><li><code>geosite:geolocation-!cn</code> - Не китайские домены</li><li><code>geosite:tld-cn</code> - Китайские домены верхнего уровня</li></ul><h2 id="распространенные-теги-geoip" tabindex="-1"><a class="header-anchor" href="#распространенные-теги-geoip"><span>Распространенные теги GeoIP</span></a></h2><ul><li><code>geoip:cn</code> - Китайские IP-адреса</li><li><code>geoip:us</code> - IP-адреса США</li><li><code>geoip:private</code> - Частные/LAN адреса</li><li><code>geoip:cloudflare</code> - IP-адреса Cloudflare</li></ul><h3 id="пользовательские-фаилы-geosite" tabindex="-1"><a class="header-anchor" href="#пользовательские-фаилы-geosite"><span>Пользовательские файлы Geosite</span></a></h3><p>Вы можете создавать пользовательские списки доменов. Подробности смотрите в <a href="custom-geodata">Пользовательские файлы Geosite</a>.</p><h2 id="продвинутые-функции" tabindex="-1"><a class="header-anchor" href="#продвинутые-функции"><span>Продвинутые функции</span></a></h2><h3 id="стратегии-сопоставления-доменов" tabindex="-1"><a class="header-anchor" href="#стратегии-сопоставления-доменов"><span>Стратегии сопоставления доменов</span></a></h3><p>Установите <strong>Domain Matcher</strong> для оптимизации производительности:</p><ul><li><strong>hybrid</strong> (по умолчанию): Сбалансированная производительность и точность</li><li><strong>linear</strong>: Последовательное сопоставление, более точное, но медленнее</li></ul><p><img src="`+d+`" alt=""></p><h3 id="использование-нескольких-критериев" tabindex="-1"><a class="header-anchor" href="#использование-нескольких-критериев"><span>Использование нескольких критериев</span></a></h3><p>Правила с несколькими критериями используют логику И. Правило совпадает только когда <strong>ВСЕ</strong> указанные условия выполнены:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token comment"># Это правило соответствует HTTPS трафику от 192.168.1.100</span></span>
<span class="line"><span class="token key atrule">Domains</span><span class="token punctuation">:</span> domain<span class="token punctuation">:</span>example.com</span>
<span class="line"><span class="token key atrule">Source IPs</span><span class="token punctuation">:</span> 192.168.1.100</span>
<span class="line"><span class="token key atrule">Ports</span><span class="token punctuation">:</span> <span class="token number">443</span></span>
<span class="line"><span class="token comment"># ВСЕ три условия должны быть истинными для совпадения</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="временное-отключение-правил" tabindex="-1"><a class="header-anchor" href="#временное-отключение-правил"><span>Временное отключение правил</span></a></h3><p>Вместо удаления правил, вы можете временно их отключить:</p><ol><li>Снимите флажок рядом с именем правила</li><li>Правило перемещается в раздел &quot;отключенные&quot;, но сохраняет свою конфигурацию</li><li>Включите снова при необходимости без переконфигурации</li></ol><h2 id="лучшие-практики" tabindex="-1"><a class="header-anchor" href="#лучшие-практики"><span>Лучшие практики</span></a></h2><h3 id="_1-начинаите-с-конкретного-затем-обобщаите" tabindex="-1"><a class="header-anchor" href="#_1-начинаите-с-конкретного-затем-обобщаите"><span>1. Начинайте с конкретного, затем обобщайте</span></a></h3><p>Начните с конкретных правил для критических сервисов, затем добавьте более общие catch-all правила.</p><h3 id="_2-используите-описательные-имена" tabindex="-1"><a class="header-anchor" href="#_2-используите-описательные-имена"><span>2. Используйте описательные имена</span></a></h3><p>Давайте правилам осмысленные имена, описывающие их назначение:</p><ul><li>✅ &quot;Netflix через прокси&quot;</li><li>❌ &quot;Правило 1&quot;</li></ul><h3 id="_3-группируите-связанные-правила" tabindex="-1"><a class="header-anchor" href="#_3-группируите-связанные-правила"><span>3. Группируйте связанные правила</span></a></h3><p>Держите похожие правила вместе для удобства управления:</p><ul><li>Группируйте все правила стриминга</li><li>Группируйте все правила блокировки</li><li>Группируйте все правила для конкретных устройств</li></ul><h3 id="_4-тестируите-перед-развертыванием" tabindex="-1"><a class="header-anchor" href="#_4-тестируите-перед-развертыванием"><span>4. Тестируйте перед развертыванием</span></a></h3><ol><li>Добавляйте новые правила как отключенные</li><li>Включайте и тестируйте индивидуально</li><li>Мониторьте логи на предмет неожиданного поведения</li><li>Корректируйте по необходимости</li></ol><h3 id="_5-регулярное-обслуживание" tabindex="-1"><a class="header-anchor" href="#_5-регулярное-обслуживание"><span>5. Регулярное обслуживание</span></a></h3><ul><li>Периодически просматривайте правила</li><li>Удаляйте устаревшие правила</li><li>Регулярно обновляйте базы данных geosite/geoip</li><li>Объединяйте похожие правила, когда возможно</li></ul><h3 id="_6-документируите-сложные-правила" tabindex="-1"><a class="header-anchor" href="#_6-документируите-сложные-правила"><span>6. Документируйте сложные правила</span></a></h3><p>Для сложных регулярных выражений или многоусловных правил добавляйте четкие имена и рассмотрите ведение внешней документации.</p><h2 id="устранение-неполадок" tabindex="-1"><a class="header-anchor" href="#устранение-неполадок"><span>Устранение неполадок</span></a></h2><h3 id="правила-не-работают" tabindex="-1"><a class="header-anchor" href="#правила-не-работают"><span>Правила не работают</span></a></h3><ol><li><p><strong>Проверьте режим DNS обхода</strong> - Ваши правила могут не достигаться из-за DNS обхода</p><ul><li>Если используете BYPASS/REDIRECT, проверьте, не обрабатываются ли домены до Xray</li><li>Попробуйте временно отключить DNS обход для изоляции проблемы</li></ul></li><li><p><strong>Проверьте политики B/R</strong> - Трафик может вообще не перехватываться</p><ul><li>Проверьте, настроено ли устройство/порт на перенаправление в Xray</li><li>Проверьте MAC-адреса и диапазоны портов</li></ul></li><li><p><strong>Проверьте порядок правил</strong> - Более конкретные правила должны идти перед общими</p></li><li><p><strong>Проверьте теги исходящих</strong> - Убедитесь, что указанное исходящее существует</p></li><li><p><strong>Проверьте синтаксис</strong> - Проверьте форматы доменов/IP</p><ul><li>Помните: <code>domain:</code> а не <code>domain.</code></li><li>Используйте <code>geosite:</code> а не <code>geosite.</code></li></ul></li><li><p><strong>Просмотрите логи</strong> - Включите логи, чтобы увидеть, какие правила срабатывают</p></li></ol><h3 id="трафик-не-идет-через-прокси" tabindex="-1"><a class="header-anchor" href="#трафик-не-идет-через-прокси"><span>Трафик не идет через прокси</span></a></h3><p><strong>Симптом</strong>: Сайты загружаются, но не проксируются, несмотря на наличие правил</p><p><strong>Распространенные причины</strong>:</p><ol><li><strong>DNS обход включен</strong> с режимом REDIRECT и домен соответствует FREEDOM</li><li><strong>Политика B/R</strong> не включает используемые порты</li><li><strong>DNS разрешение</strong> происходит перед прокси (проверьте предотвращение утечки DNS)</li><li><strong>QUIC/HTTP3</strong> трафик на UDP 443 не перехватывается</li></ol><p><strong>Шаги решения</strong>:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token number">1</span>. Временно установите DNS обход в OFF</span>
<span class="line"><span class="token number">2</span>. Убедитесь, что политика B/R включает и TCP, и UDP</span>
<span class="line"><span class="token number">3</span>. Добавьте UDP порт <span class="token number">443</span> в вашу политику перенаправления</span>
<span class="line"><span class="token number">4</span>. Проверьте логи, чтобы убедиться, что трафик достигает Xray</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="неожиданные-прямые-соединения" tabindex="-1"><a class="header-anchor" href="#неожиданные-прямые-соединения"><span>Неожиданные прямые соединения</span></a></h3><p><strong>Симптом</strong>: Некоторый трафик обходит прокси без соответствия какому-либо правилу прямого соединения</p><p><strong>Проверьте</strong>:</p><ol><li><strong>Правила ipset</strong> от DNS обхода, создающие обходы на уровне ядра</li><li><strong>Системные DNS</strong> запросы не перехватываются</li><li><strong>IPv6 трафик</strong>, если не обрабатывается правильно</li><li><strong>Кэшированные DNS</strong> ответы от предыдущего изменения конфигурации</li></ol><h3 id="проблемы-с-производительностью" tabindex="-1"><a class="header-anchor" href="#проблемы-с-производительностью"><span>Проблемы с производительностью</span></a></h3><p>Если маршрутизация медленная:</p><ol><li>Уменьшите использование регулярных выражений (наиболее ресурсоемкие)</li><li>Объедините похожие правила</li><li>Используйте теги geosite вместо перечисления многих доменов</li><li>Переключите сопоставитель доменов на &quot;linear&quot;, если точность важнее скорости</li></ol><h3 id="отладка-правил" tabindex="-1"><a class="header-anchor" href="#отладка-правил"><span>Отладка правил</span></a></h3><p>Включите логирование для просмотра совпадений правил:</p><ol><li>Перейдите в <strong>General Options</strong> → <strong>Logs</strong></li><li>Включите <strong>Access logs</strong></li><li>Установите <strong>Log level</strong> в &quot;info&quot; или &quot;debug&quot;</li><li>Проверяйте логи, чтобы увидеть, какие правила срабатывают</li></ol><h3 id="распространенные-ошибки-которых-следует-избегать" tabindex="-1"><a class="header-anchor" href="#распространенные-ошибки-которых-следует-избегать"><span>Распространенные ошибки, которых следует избегать</span></a></h3><ul><li><strong>Неправильный формат префикса</strong>: Используйте <code>domain:</code> а не <code>domain.</code></li><li><strong>Путаница с форматом порта</strong>: Используйте <code>:</code> для диапазонов (8080:8090), а не <code>-</code></li><li><strong>Отсутствующий тип сети</strong>: Укажите tcp, udp или оба</li><li><strong>Неправильный порядок правил</strong>: Catch-all правила размещены слишком рано</li><li><strong>Конфликтующие правила</strong>: Несколько правил соответствуют одному и тому же трафику</li></ul><h2 id="краткии-справочник" tabindex="-1"><a class="header-anchor" href="#краткии-справочник"><span>Краткий справочник</span></a></h2><h3 id="префиксы-доменов" tabindex="-1"><a class="header-anchor" href="#префиксы-доменов"><span>Префиксы доменов</span></a></h3><table><thead><tr><th>Префикс</th><th>Соответствует</th><th>Пример</th></tr></thead><tbody><tr><td><code>domain:</code></td><td>Домен и все поддомены</td><td><code>domain:google.com</code> совпадает с <code>maps.google.com</code></td></tr><tr><td><code>full:</code></td><td>Только точный домен</td><td><code>full:google.com</code> совпадает только с <code>google.com</code></td></tr><tr><td><code>keyword:</code></td><td>Содержит ключевое слово</td><td><code>keyword:google</code> совпадает с <code>googleplex.com</code></td></tr><tr><td><code>regexp:</code></td><td>Регулярное выражение</td><td><code>regexp:.*\\.edu$</code> совпадает с доменами <code>.edu</code></td></tr><tr><td><code>geosite:</code></td><td>База данных Geosite</td><td><code>geosite:netflix</code></td></tr><tr><td><code>ext:xrayui:</code></td><td>Пользовательские списки xrayui</td><td><code>ext:xrayui:mylist</code></td></tr></tbody></table><h2 id="дерево-решении-конфигурации" tabindex="-1"><a class="header-anchor" href="#дерево-решении-конфигурации"><span>Дерево решений конфигурации</span></a></h2><p>При настройке маршрутизации в xrayui следуйте этому дереву решений:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">1. Сколько трафика нужно проксировать?</span>
<span class="line">   ├─ Большая часть трафика → DNS обход OFF</span>
<span class="line">   └─ Выборочно → DNS обход ON</span>
<span class="line">       ├─ Проксировать конкретные сайты → режим REDIRECT</span>
<span class="line">       └─ Обходить конкретные сайты → режим BYPASS</span>
<span class="line"></span>
<span class="line">2. Какие устройства нужно проксировать?</span>
<span class="line">   ├─ Все устройства → Политика B/R: Перенаправить все</span>
<span class="line">   └─ Конкретные устройства → Политика B/R: По MAC/IP</span>
<span class="line"></span>
<span class="line">3. Какие порты перехватывать?</span>
<span class="line">   ├─ Только веб → TCP/UDP 80,443</span>
<span class="line">   ├─ Весь трафик → Все порты</span>
<span class="line">   └─ Пользовательские приложения → Конкретные диапазоны портов</span>
<span class="line"></span>
<span class="line">4. Насколько сложна маршрутизация?</span>
<span class="line">   ├─ Простая (прокси/прямо) → Базовые правила</span>
<span class="line">   ├─ По сервису → Используйте категории geosite</span>
<span class="line">   └─ Сложная логика → Несколько уровней правил</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="резюме" tabindex="-1"><a class="header-anchor" href="#резюме"><span>Резюме</span></a></h2><p>Эффективная маршрутизация в xrayui требует понимания трех уровней:</p><h3 id="уровень-1-политики-b-r" tabindex="-1"><a class="header-anchor" href="#уровень-1-политики-b-r"><span>Уровень 1: Политики B/R</span></a></h3><p>Контролирует, какие устройства и порты перехватываются системой.</p><h3 id="уровень-2-dns-обход" tabindex="-1"><a class="header-anchor" href="#уровень-2-dns-обход"><span>Уровень 2: DNS обход</span></a></h3><p>Предварительно фильтрует трафик перед Xray, улучшая производительность, но снижая контроль.</p><h3 id="уровень-3-правила-маршрутизации-xray-1" tabindex="-1"><a class="header-anchor" href="#уровень-3-правила-маршрутизации-xray-1"><span>Уровень 3: Правила маршрутизации Xray</span></a></h3><p>Детальный контроль над трафиком, который достигает Xray.</p><p><strong>Ключевые концепции для запоминания:</strong></p><ul><li>Не весь трафик автоматически проходит через Xray</li><li>DNS обход может помешать оценке правил</li><li>Порядок правил важен (первое совпадение выигрывает)</li><li>Категории Geosite упрощают управление доменами</li><li>Разные префиксы доменов служат разным целям</li><li>Производительность и контроль часто являются компромиссами</li></ul><p><strong>Лучшие практики:</strong></p><ol><li>Начните с DNS обхода OFF, чтобы понять поток трафика</li><li>Используйте категории geosite вместо перечисления отдельных доменов</li><li>Тестируйте правила пошагово</li><li>Мониторьте логи во время первоначальной настройки</li><li>Оптимизируйте с DNS обходом после правильной работы маршрутизации</li><li>Документируйте сложные конфигурации</li></ol><div class="hint-container note"><p class="hint-container-title">Заметка</p><p>Не забудьте нажать <strong>Apply</strong> на главной странице после внесения любых изменений конфигурации для активации вашей новой настройки маршрутизации.</p></div>`,214))])}const x=c(g,[["render",v]]),f=JSON.parse('{"path":"/ru/routing.html","title":"Руководство по правилам маршрутизации","lang":"ru-RU","frontmatter":{},"git":{"updatedTime":1761350718000,"contributors":[{"name":"Daniel Lavrushin","username":"","email":"lavrushin@gmail.com","commits":1}],"changelog":[{"hash":"198f5dcc71b58fcec3c0f1f2ab3ac9a636f56216","time":1761350718000,"email":"lavrushin@gmail.com","author":"Daniel Lavrushin","message":"Add Russian documentation for routing rules and v2dat usage in XRAYUI"}]},"filePathRelative":"ru/routing.md"}');export{x as comp,f as data};
