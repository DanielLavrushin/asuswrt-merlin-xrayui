import{_ as t,a as o,b as l,c as r}from"./20251025013437-C6_y1YdW.js";import{_ as c,c as d,a as n,b as s,e as a,d as p,w as u,r as h,o as g}from"./app-eTybrgsj.js";const m={};function b(f,e){const i=h("RouteLink");return g(),d("div",null,[e[4]||(e[4]=n('<h1 id="routing-rules-guide" tabindex="-1"><a class="header-anchor" href="#routing-rules-guide"><span>Routing Rules Guide</span></a></h1><p>Routing rules are the core of Xray&#39;s traffic control system. They determine which outbound connection (outbound proxy (<code>vless</code>/<code>vmess</code>/<code>xhttp</code> etc), direct(<code>freedom</code>), or block(<code>blackhole</code>)) should handle specific traffic based on various criteria like domains, IPs, ports, and protocols.</p><h2 id="traffic-flow-architecture" tabindex="-1"><a class="header-anchor" href="#traffic-flow-architecture"><span>Traffic Flow Architecture</span></a></h2><p>Before diving into routing rules, it&#39;s crucial to understand that <strong>not all traffic automatically goes through Xray</strong>. The XRAYUI module implements a multi-layer traffic control system:</p><h3 id="layer-1-system-level-interception" tabindex="-1"><a class="header-anchor" href="#layer-1-system-level-interception"><span>Layer 1: System-Level Interception</span></a></h3><p>First, the router decides what traffic to intercept based on your basic configuration:</p>',6)),s("ul",null,[s("li",null,[s("strong",null,[p(i,{to:"/en/br-policy.html"},{default:u(()=>e[0]||(e[0]=[a("Bypass/Redirect Policies",-1)])),_:1,__:[0]})]),e[1]||(e[1]=a(" determine which devices and ports are handled",-1))]),e[2]||(e[2]=s("li",null,[s("strong",null,[s("a",{href:"general-options#enable-dns-bypass-ipset"},"DNS Bypass Mode")]),a(" affects how domain-based decisions are made")],-1)),e[3]||(e[3]=s("li",null,"Only intercepted traffic reaches Xray for processing",-1))]),e[5]||(e[5]=n(`<h3 id="layer-2-dns-resolution-bypass" tabindex="-1"><a class="header-anchor" href="#layer-2-dns-resolution-bypass"><span>Layer 2: DNS Resolution &amp; Bypass</span></a></h3><p>Before Xray routing rules are evaluated, the <strong>DNS Bypass/Redirect</strong> feature can make routing decisions.</p><p>Initially, the module intercepts any traffic (well, almost any, but that&#39;s not important in this case) and redirects it to Xray&#39;s dokodemo inbound port. As it turned out, under heavy loads, Xray struggles to handle such traffic flow on weak routers.</p><h4 id="dns-bypass-modes" tabindex="-1"><a class="header-anchor" href="#dns-bypass-modes"><span>DNS Bypass Modes</span></a></h4><ul><li><p><strong>OFF</strong>: All intercepted traffic goes to Xray for rule-based routing</p></li><li><p><strong>BYPASS</strong>: Extracts all rules from the config that are specified with <code>FREEDOM</code> outbound type, and essentially any traffic to these domains won&#39;t be sent to Xray. For example, if you made a rule <code>domain:ru</code> to FREEDOM - this way any traffic to .ru domains won&#39;t be thrown to Xray, but will flow as if there&#39;s no Xray on the router at all. Other traffic goes through Xray.</p></li><li><p><strong>REDIRECT</strong>: Works opposite to bypass - extracts all rules where the outbound type is NOT FREEDOM and sends them to Xray. So if you made a rule <code>geosite:youtube</code> to proxy outbound, this way all traffic except YouTube domains will bypass Xray, and YouTube will be thrown to the Xray process.</p></li></ul><div class="hint-container important"><p class="hint-container-title">Important</p><p>DNS Bypass/Redirect happens BEFORE Xray routing rules! This is traffic routing even before it gets into the Xray process. It&#39;s important to remember that how and where your traffic goes inside Xray depends on your rules in Xray, but that&#39;s another story entirely.</p></div><div class="hint-container note"><p class="hint-container-title">Note</p><p>Important point: in geodata categories, you may occasionally (very rarely, but it happens) encounter <code>regexp:</code> prefixes for domains. Such &quot;domains&quot; are ignored by the &quot;enable DNS bypass&quot; option and won&#39;t work, but this is, let&#39;s say, a minor issue.</p></div><h3 id="layer-3-xray-routing-rules" tabindex="-1"><a class="header-anchor" href="#layer-3-xray-routing-rules"><span>Layer 3: Xray Routing Rules</span></a></h3><p>Only traffic that passes through the previous layers reaches Xray&#39;s routing engine, where your rules are evaluated sequentially.</p><h2 id="understanding-domain-prefixes" tabindex="-1"><a class="header-anchor" href="#understanding-domain-prefixes"><span>Understanding Domain Prefixes</span></a></h2><p>Domain routing in Xray provides flexible traffic management through various matching approaches. Understanding these prefixes is essential for effective rule creation.</p><h3 id="basic-domain-matching" tabindex="-1"><a class="header-anchor" href="#basic-domain-matching"><span>Basic Domain Matching</span></a></h3><p>The <code>domain:</code> prefix is the foundation of domain-based routing:</p><ul><li><p><strong><code>domain:com</code></strong> — Matches ALL .com top-level domains and their subdomains</p><ul><li>✅ Matches: <code>dmn.com</code>, <code>example.com</code>, <code>sub.example.com</code></li><li>❌ Doesn&#39;t match: <code>us.com</code>, <code>us-server.net</code></li></ul></li><li><p><strong><code>domain:dmn.com</code></strong> — Matches the domain and all its subdomains</p><ul><li>✅ Matches: <code>dmn.com</code>, <code>www.dmn.com</code>, <code>some.sub.domain.dmn.com</code></li><li>❌ Doesn&#39;t match: <code>domains.com</code>, <code>notdmn.com</code></li></ul></li><li><p><strong><code>domain:www.dmn.com</code></strong> — Matches only this specific subdomain and its sub-subdomains</p><ul><li>✅ Matches: <code>www.dmn.com</code>, <code>api.www.dmn.com</code></li><li>❌ Doesn&#39;t match: <code>dmn.com</code>, <code>m.dmn.com</code></li></ul></li></ul><h3 id="full-domain-matching" tabindex="-1"><a class="header-anchor" href="#full-domain-matching"><span>Full Domain Matching</span></a></h3><p>Use <code>full:</code> when you need exact domain matching without subdomains:</p><ul><li><strong><code>full:google.com</code></strong> — Matches ONLY <code>google.com</code><ul><li>✅ Matches: <code>google.com</code></li><li>❌ Doesn&#39;t match: <code>www.google.com</code>, <code>maps.google.com</code></li></ul></li></ul><h3 id="pattern-matching" tabindex="-1"><a class="header-anchor" href="#pattern-matching"><span>Pattern Matching</span></a></h3><p>For more flexible matching, use keyword and regex patterns:</p><ul><li><p><strong><code>keyword:google</code></strong> — Matches any domain containing &quot;google&quot;</p><ul><li>✅ Matches: <code>google.com</code>, <code>googleusercontent.com</code>, <code>mygooglesite.net</code></li></ul></li><li><p><strong><code>regexp:.*\\.edu$</code></strong> — Matches domains ending with .edu using regular expressions</p><ul><li>✅ Matches: <code>harvard.edu</code>, <code>mit.edu</code></li><li>❌ Doesn&#39;t match: <code>education.com</code></li></ul></li></ul><h2 id="working-with-geosite-databases" tabindex="-1"><a class="header-anchor" href="#working-with-geosite-databases"><span>Working with Geosite Databases</span></a></h2><p>For managing large collections of domains efficiently, Xray supports geosite files. These are community-maintained databases that group hundreds or thousands of related domains under single tags.</p><h3 id="why-use-geosite" tabindex="-1"><a class="header-anchor" href="#why-use-geosite"><span>Why Use Geosite?</span></a></h3><p>Instead of manually listing dozens of domains for a service like YouTube:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">domain:youtube.com</span>
<span class="line">domain:youtube.ru</span>
<span class="line">domain:youtu.be</span>
<span class="line">domain:youtubeeducation.com</span>
<span class="line">domain:youtube-nocookie.com</span>
<span class="line">domain:googleapis.com</span>
<span class="line"># ... and many more</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can simply use:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">geosite:youtube</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>This automatically includes ALL YouTube-related domains from the community database, including CDNs, API endpoints, and regional variants.</p><h3 id="available-geosite-categories" tabindex="-1"><a class="header-anchor" href="#available-geosite-categories"><span>Available Geosite Categories</span></a></h3><p>The community maintains extensive domain lists. You can find all available categories at: <a href="https://github.com/v2fly/domain-list-community/tree/master/data" target="_blank" rel="noopener noreferrer">GitHub: v2fly/domain-list-community</a></p><p>Common categories include:</p><ul><li><code>geosite:google</code> — All Google services</li><li><code>geosite:youtube</code> — YouTube and related domains</li><li><code>geosite:netflix</code> — Netflix streaming service</li><li><code>geosite:telegram</code> — Telegram messenger</li><li><code>geosite:facebook</code> — Facebook and Instagram</li><li><code>geosite:twitter</code> — Twitter/X platform</li><li><code>geosite:cn</code> — Chinese websites</li><li><code>geosite:category-media-ru</code> - All banned media in Russia</li><li><code>geosite:category-ads-all</code> — Advertisement networks</li><li><code>geosite:geolocation-!cn</code> — Non-Chinese sites</li></ul><h3 id="understanding-category-contents" tabindex="-1"><a class="header-anchor" href="#understanding-category-contents"><span>Understanding Category Contents</span></a></h3><p>Let&#39;s examine how categories work with a simple example:</p><p>The <code>geosite:actalis</code> category contains just two domains:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">domain:actalis.com</span>
<span class="line">domain:actalis.it</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>When you use <code>geosite:actalis</code>, it&#39;s equivalent to adding both domains manually. However, the key advantage is <strong>automatic updates</strong> — if the community adds new Actalis domains in the future, your rules automatically include them when you update the geosite database.</p><h3 id="community-contributions" tabindex="-1"><a class="header-anchor" href="#community-contributions"><span>Community Contributions</span></a></h3><p>The geosite database is community-driven. For example, the <code>category-media-ru</code> category was recently added:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">geosite:category-media-ru</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>This now automatically includes all category-media-ru-related domains without needing to list them individually.</p><h3 id="creating-custom-geosite-categories" tabindex="-1"><a class="header-anchor" href="#creating-custom-geosite-categories"><span>Creating Custom Geosite Categories</span></a></h3><p>You can create your own domain lists using xrayui&#39;s custom geosite feature: Read more about <a href="/en/custom-geodata" target="_blank" rel="noopener noreferrer">custom geosite dat files</a>.</p><h3 id="updating-geosite-databases" tabindex="-1"><a class="header-anchor" href="#updating-geosite-databases"><span>Updating Geosite Databases</span></a></h3><p>The community geosite databases are regularly updated with new domains and categories. To keep your routing accurate:</p><h4 id="manual-update" tabindex="-1"><a class="header-anchor" href="#manual-update"><span>Manual Update</span></a></h4><ol><li>Go to <strong>Routing</strong> section</li><li>Click <strong>Update community files</strong> button</li><li>Wait for the update to complete</li><li>Apply configuration</li></ol><h4 id="automatic-updates" tabindex="-1"><a class="header-anchor" href="#automatic-updates"><span>Automatic Updates</span></a></h4><ol><li>Go to <strong>General Options</strong> → <strong>Geodata</strong> tab</li><li>Enable <strong>Auto-update geodata files</strong></li><li>Updates will occur nightly at 03:00</li></ol><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Regular updates ensure your rules catch newly added domains for services like streaming platforms that frequently add new CDN endpoints.</p></div><h3 id="verifying-geosite-contents" tabindex="-1"><a class="header-anchor" href="#verifying-geosite-contents"><span>Verifying Geosite Contents</span></a></h3><p>To see what domains are included in a geosite category:</p><ol><li>Check the <a href="https://github.com/v2fly/domain-list-community/tree/master/data" target="_blank" rel="noopener noreferrer">official repository</a></li><li>Search for the category file (e.g., <code>youtube</code>)</li><li>Review the included domains and patterns</li></ol><p>This helps you understand exactly what traffic your rules will match.</p><h2 id="understanding-routing-rules" tabindex="-1"><a class="header-anchor" href="#understanding-routing-rules"><span>Understanding Routing Rules</span></a></h2><p>In <code>XRAYUI</code>, routing rules work as a <strong>sequential decision tree</strong>. When traffic arrives, Xray evaluates rules from top to bottom and applies the <strong>first matching rule</strong>. If no rules match, traffic uses the default behavior.</p><div class="hint-container important"><p class="hint-container-title">Important</p><p>Rule order matters! Rules are evaluated sequentially, so more specific rules should generally come before broader ones.</p></div><h2 id="the-rules-interface" tabindex="-1"><a class="header-anchor" href="#the-rules-interface"><span>The Rules Interface</span></a></h2><p>To manage routing rules in <code>XRAYUI</code>:</p><ol><li>Navigate to the <strong>Routing</strong> section on the main page <img src="`+t+'" alt=""></li><li>Click the <strong>Manage</strong> button next to <strong>Rules</strong></li><li>The Rules Manager window will open <img src="'+o+'" alt=""></li></ol><h2 id="adding-a-new-rule" tabindex="-1"><a class="header-anchor" href="#adding-a-new-rule"><span>Adding a New Rule</span></a></h2><h3 id="step-1-open-the-rule-editor" tabindex="-1"><a class="header-anchor" href="#step-1-open-the-rule-editor"><span>Step 1: Open the Rule Editor</span></a></h3><p>Click <strong>Add new rule</strong> at the bottom of the Rules Manager window.</p><h3 id="step-2-configure-basic-settings" tabindex="-1"><a class="header-anchor" href="#step-2-configure-basic-settings"><span>Step 2: Configure Basic Settings</span></a></h3><table><thead><tr><th>Field</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td><strong>Friendly Name</strong></td><td>Optional descriptive name for your rule</td><td>&quot;Netflix to Proxy&quot;</td></tr><tr><td><strong>Outbound connection</strong></td><td>Which outbound to use when rule matches</td><td>proxy, direct, block</td></tr><tr><td><strong>Enabled</strong></td><td>Toggle rule on/off without deleting</td><td>✓ (checked)</td></tr></tbody></table><h3 id="step-3-define-matching-criteria" tabindex="-1"><a class="header-anchor" href="#step-3-define-matching-criteria"><span>Step 3: Define Matching Criteria</span></a></h3><p><img src="'+l+`" alt=""></p><p>Rules can match traffic based on multiple criteria:</p><h4 id="domains" tabindex="-1"><a class="header-anchor" href="#domains"><span>Domains</span></a></h4><p>Enter domains to match, one per line. Supports multiple formats:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># Exact domain and subdomains</span>
<span class="line">domain:google.com</span>
<span class="line"></span>
<span class="line"># Only exact match</span>
<span class="line">full:www.google.com</span>
<span class="line"></span>
<span class="line"># Keyword matching</span>
<span class="line">keyword:facebook</span>
<span class="line"></span>
<span class="line"># Regular expression</span>
<span class="line">regexp:.*\\.gov$</span>
<span class="line"></span>
<span class="line"># Geosite databases</span>
<span class="line">geosite:netflix</span>
<span class="line">geosite:category-ads</span>
<span class="line">ext:xrayui:streaming</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Use the <strong>geosite:</strong> and <strong>ext:xrayui:</strong> buttons above the domain field for quick prefix insertion. The autocomplete feature will help you find available tags.</p></div><h4 id="ip-addresses" tabindex="-1"><a class="header-anchor" href="#ip-addresses"><span>IP Addresses</span></a></h4><p>Specify IP addresses or ranges:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># Single IP</span>
<span class="line">1.1.1.1</span>
<span class="line"></span>
<span class="line"># CIDR notation</span>
<span class="line">192.168.1.0/24</span>
<span class="line"></span>
<span class="line"># IP range</span>
<span class="line">10.0.0.1-10.0.0.100</span>
<span class="line"></span>
<span class="line"># GeoIP database</span>
<span class="line">geoip:cn</span>
<span class="line">geoip:ru</span>
<span class="line">geoip:private</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ports" tabindex="-1"><a class="header-anchor" href="#ports"><span>Ports</span></a></h4><p>Define specific ports or ranges:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># Single port</span>
<span class="line">443</span>
<span class="line"></span>
<span class="line"># Port range (use colon)</span>
<span class="line">8080:8090</span>
<span class="line"></span>
<span class="line"># Multiple ports</span>
<span class="line">80,443,8080</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="source-ips" tabindex="-1"><a class="header-anchor" href="#source-ips"><span>Source IPs</span></a></h4><p>Match traffic from specific source IPs (useful for device-specific rules):</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">192.168.1.100</span>
<span class="line">192.168.1.0/24</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="protocols" tabindex="-1"><a class="header-anchor" href="#protocols"><span>Protocols</span></a></h4><p>Select protocols to match:</p><ul><li>HTTP</li><li>TLS (HTTPS)</li><li>BitTorrent</li></ul><h4 id="network-type" tabindex="-1"><a class="header-anchor" href="#network-type"><span>Network Type</span></a></h4><p>Choose the transport protocol:</p><ul><li>TCP</li><li>UDP</li><li>TCP,UDP (both)</li></ul><h4 id="inbound-tags" tabindex="-1"><a class="header-anchor" href="#inbound-tags"><span>Inbound Tags</span></a></h4><p>Match traffic from specific inbounds (useful when you have multiple entry points).</p><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Remember the <strong>Golden Rule</strong>: If nothing is selected - everything is selected. it means you dont need to select everything to cover all. Just leave ithe field blank.</p></div><h3 id="step-4-save-the-rule" tabindex="-1"><a class="header-anchor" href="#step-4-save-the-rule"><span>Step 4: Save the Rule</span></a></h3><p>Click <strong>Save</strong> to add the rule to your configuration.</p><h2 id="practical-examples-dns-bypass-routing-rules" tabindex="-1"><a class="header-anchor" href="#practical-examples-dns-bypass-routing-rules"><span>Practical Examples: DNS Bypass + Routing Rules</span></a></h2><p>Understanding how DNS Bypass and routing rules interact is crucial for proper configuration. Here are real-world scenarios:</p><h3 id="scenario-1-performance-optimization" tabindex="-1"><a class="header-anchor" href="#scenario-1-performance-optimization"><span>Scenario 1: Performance Optimization</span></a></h3><p><strong>Goal</strong>: Proxy only blocked services, everything else direct</p><p><strong>Configuration</strong>:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">DNS B/R Option</span><span class="token punctuation">:</span> REDIRECT mode</span>
<span class="line"><span class="token key atrule">B/R Policy</span><span class="token punctuation">:</span> Redirect ports 80<span class="token punctuation">,</span><span class="token number">443</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Routing Rules</span><span class="token punctuation">:</span></span>
<span class="line">1. YouTube → geosite<span class="token punctuation">:</span>youtube → proxy</span>
<span class="line">2. Netflix → geosite<span class="token punctuation">:</span>netflix → proxy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Result</strong>: Only YouTube and Netflix go through Xray. All other traffic bypasses Xray entirely at the DNS/IPSET level, reducing CPU load.</p><h3 id="scenario-2-maximum-control" tabindex="-1"><a class="header-anchor" href="#scenario-2-maximum-control"><span>Scenario 2: Maximum Control</span></a></h3><p><strong>Goal</strong>: Complex routing with different proxies for different services</p><p><strong>Configuration</strong>:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">DNS Bypass</span><span class="token punctuation">:</span> OFF</span>
<span class="line"><span class="token key atrule">B/R Policy</span><span class="token punctuation">:</span> all to xray</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Routing Rules</span><span class="token punctuation">:</span></span>
<span class="line">1. Work traffic → domain<span class="token punctuation">:</span>company.com → work<span class="token punctuation">-</span>proxy</span>
<span class="line">2. Streaming → geosite<span class="token punctuation">:</span>netflix → us<span class="token punctuation">-</span>proxy</span>
<span class="line">3. Social Media → geosite<span class="token punctuation">:</span>twitter → europe<span class="token punctuation">-</span>proxy</span>
<span class="line">4. Gaming → ports<span class="token punctuation">:</span>27000<span class="token punctuation">-</span>27100 → direct</span>
<span class="line">5. Default → * → smart<span class="token punctuation">-</span>proxy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Result</strong>: All traffic goes through Xray for evaluation, allowing sophisticated routing decisions.</p><h3 id="scenario-3-device-specific-with-bypass" tabindex="-1"><a class="header-anchor" href="#scenario-3-device-specific-with-bypass"><span>Scenario 3: Device-Specific with Bypass</span></a></h3><p><strong>Goal</strong>: Smart TV direct, other devices proxied</p><p><strong>Configuration</strong>:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">DNS Bypass</span><span class="token punctuation">:</span> BYPASS mode</span>
<span class="line"><span class="token key atrule">B/R Policy</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> Bypass MAC<span class="token punctuation">:</span>AA<span class="token punctuation">:</span>BB<span class="token punctuation">:</span>CC<span class="token punctuation">:</span>DD<span class="token punctuation">:</span>EE<span class="token punctuation">:</span>FF (Smart TV)</span>
<span class="line">  <span class="token punctuation">-</span> Redirect others on ports 80<span class="token punctuation">,</span><span class="token number">443</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">Routing Rules</span><span class="token punctuation">:</span></span>
<span class="line">1. Local network → geoip<span class="token punctuation">:</span>private → direct</span>
<span class="line">2. Blocked sites → geosite<span class="token punctuation">:</span>netflix → proxy</span>
<span class="line">3. Default → * → proxy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Result</strong>: Smart TV never reaches Xray. Other devices have Netflix proxied, rest goes direct via DNS bypass.</p><h2 id="rule-priority-and-ordering" tabindex="-1"><a class="header-anchor" href="#rule-priority-and-ordering"><span>Rule Priority and Ordering</span></a></h2><p>Rules are processed in order from top to bottom. Here&#39;s the recommended priority order:</p><ol><li><strong>System rules</strong> (xrayui auto-generated, usually at the top, start with prefix <code>sys:</code>)</li><li><strong>Blocking rules</strong> (ads, malware, trackers)</li><li><strong>Device-specific rules</strong> (by source IP/MAC)</li><li><strong>Service-specific rules</strong> (streaming, gaming)</li><li><strong>Port-based rules</strong> (specific applications)</li><li><strong>Geographic rules</strong> (country-based routing)</li><li><strong>Catch-all rules</strong> (default behavior)</li></ol><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Use the drag handle (⋮⋮) on the left of each rule to reorder them. The visual order in the list represents the actual evaluation order.</p></div><h3 id="interaction-with-dns-bypass" tabindex="-1"><a class="header-anchor" href="#interaction-with-dns-bypass"><span>Interaction with DNS Bypass</span></a></h3><p>Remember that DNS Bypass mode affects which traffic reaches your rules:</p><p><strong>In BYPASS mode:</strong></p><ul><li>Domains matching rules with <code>FREEDOM</code> outbound never reach Xray</li><li>Only non-FREEDOM domains are evaluated by routing rules</li><li>This improves performance but reduces control</li></ul><p><strong>In REDIRECT mode:</strong></p><ul><li>Only domains NOT matching FREEDOM rules go through Xray</li><li>Inverse logic of BYPASS mode</li><li>Useful when most traffic should be direct</li></ul><p><strong>With DNS Bypass OFF:</strong></p><ul><li>All intercepted traffic reaches Xray routing rules</li><li>Maximum control but higher resource usage</li><li>Recommended for complex routing scenarios</li></ul><div class="hint-container warning"><p class="hint-container-title">Warning</p><p>If using DNS Bypass, ensure your FREEDOM rules in Xray align with your bypass intentions. Misalignment can cause unexpected routing behavior.</p></div><h2 id="working-with-geosite-geoip" tabindex="-1"><a class="header-anchor" href="#working-with-geosite-geoip"><span>Working with Geosite/GeoIP</span></a></h2><h3 id="using-built-in-databases" tabindex="-1"><a class="header-anchor" href="#using-built-in-databases"><span>Using Built-in Databases</span></a></h3><p><strong>XRAYUI</strong> includes community-maintained geographic databases:</p><p><strong>Common Geosite Tags:</strong></p><ul><li><code>geosite:google</code> - All Google services</li><li><code>geosite:facebook</code> - Facebook and subsidiaries</li><li><code>geosite:netflix</code> - Netflix domains</li><li><code>geosite:telegram</code> - Telegram messenger</li><li><code>geosite:cn</code> - Chinese websites</li><li><code>geosite:category-ads-all</code> - Advertisement domains</li></ul><p><strong>Common GeoIP Tags:</strong></p><ul><li><code>geoip:cn</code> - Chinese IP addresses</li><li><code>geoip:us</code> - US IP addresses</li><li><code>geoip:private</code> - Private/LAN addresses</li><li><code>geoip:cloudflare</code> - Cloudflare IPs</li></ul><h3 id="custom-geosite-files" tabindex="-1"><a class="header-anchor" href="#custom-geosite-files"><span>Custom Geosite Files</span></a></h3><p>You can create custom domain lists. See <a href="custom-geodata">Custom Geosite Files</a> for details.</p><h2 id="advanced-features" tabindex="-1"><a class="header-anchor" href="#advanced-features"><span>Advanced Features</span></a></h2><h3 id="domain-matching-strategies" tabindex="-1"><a class="header-anchor" href="#domain-matching-strategies"><span>Domain Matching Strategies</span></a></h3><p>Set the <strong>Domain Matcher</strong> to optimize performance:</p><ul><li><strong>hybrid</strong> (default): Balanced performance and accuracy</li><li><strong>linear</strong>: Sequential matching, more accurate but slower</li></ul><p><img src="`+r+`" alt=""></p><h3 id="using-multiple-criteria" tabindex="-1"><a class="header-anchor" href="#using-multiple-criteria"><span>Using Multiple Criteria</span></a></h3><p>Rules with multiple criteria use AND logic. The rule matches only when <strong>ALL</strong> specified conditions are met:</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token comment"># This rule matches HTTPS traffic from 192.168.1.100</span></span>
<span class="line"><span class="token key atrule">Domains</span><span class="token punctuation">:</span> domain<span class="token punctuation">:</span>example.com</span>
<span class="line"><span class="token key atrule">Source IPs</span><span class="token punctuation">:</span> 192.168.1.100</span>
<span class="line"><span class="token key atrule">Ports</span><span class="token punctuation">:</span> <span class="token number">443</span></span>
<span class="line"><span class="token comment"># ALL three conditions must be true for a match</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="temporary-rule-disabling" tabindex="-1"><a class="header-anchor" href="#temporary-rule-disabling"><span>Temporary Rule Disabling</span></a></h3><p>Instead of deleting rules, you can temporarily disable them:</p><ol><li>Uncheck the checkbox next to the rule name</li><li>The rule moves to the &quot;disabled&quot; section but retains its configuration</li><li>Re-enable when needed without reconfiguration</li></ol><h2 id="best-practices" tabindex="-1"><a class="header-anchor" href="#best-practices"><span>Best Practices</span></a></h2><h3 id="_1-start-specific-then-generalize" tabindex="-1"><a class="header-anchor" href="#_1-start-specific-then-generalize"><span>1. Start Specific, Then Generalize</span></a></h3><p>Begin with specific rules for critical services, then add broader catch-all rules.</p><h3 id="_2-use-descriptive-names" tabindex="-1"><a class="header-anchor" href="#_2-use-descriptive-names"><span>2. Use Descriptive Names</span></a></h3><p>Give rules meaningful names that describe their purpose:</p><ul><li>✅ &quot;Netflix to Proxy&quot;</li><li>❌ &quot;Rule 1&quot;</li></ul><h3 id="_3-group-related-rules" tabindex="-1"><a class="header-anchor" href="#_3-group-related-rules"><span>3. Group Related Rules</span></a></h3><p>Keep similar rules together for easier management:</p><ul><li>Group all streaming rules</li><li>Group all blocking rules</li><li>Group all device-specific rules</li></ul><h3 id="_4-test-before-deploying" tabindex="-1"><a class="header-anchor" href="#_4-test-before-deploying"><span>4. Test Before Deploying</span></a></h3><ol><li>Add new rules as disabled</li><li>Enable and test individually</li><li>Monitor logs for unexpected behavior</li><li>Adjust as needed</li></ol><h3 id="_5-regular-maintenance" tabindex="-1"><a class="header-anchor" href="#_5-regular-maintenance"><span>5. Regular Maintenance</span></a></h3><ul><li>Review rules periodically</li><li>Remove obsolete rules</li><li>Update geosite/geoip databases regularly</li><li>Consolidate similar rules when possible</li></ul><h3 id="_6-document-complex-rules" tabindex="-1"><a class="header-anchor" href="#_6-document-complex-rules"><span>6. Document Complex Rules</span></a></h3><p>For complex regex or multi-condition rules, add clear names and consider keeping external documentation.</p><h2 id="troubleshooting" tabindex="-1"><a class="header-anchor" href="#troubleshooting"><span>Troubleshooting</span></a></h2><h3 id="rules-not-working" tabindex="-1"><a class="header-anchor" href="#rules-not-working"><span>Rules Not Working</span></a></h3><ol><li><p><strong>Check DNS Bypass mode</strong> - Your rules might not be reached due to DNS bypass</p><ul><li>If using BYPASS/REDIRECT, verify domains aren&#39;t being handled before Xray</li><li>Try temporarily disabling DNS bypass to isolate the issue</li></ul></li><li><p><strong>Verify B/R Policies</strong> - Traffic might not be intercepted at all</p><ul><li>Check if the device/port is set to redirect to Xray</li><li>Verify MAC addresses and port ranges</li></ul></li><li><p><strong>Check rule order</strong> - More specific rules must come before general ones</p></li><li><p><strong>Verify outbound tags</strong> - Ensure the specified outbound exists</p></li><li><p><strong>Check syntax</strong> - Validate domain/IP formats</p><ul><li>Remember: <code>domain:</code> not <code>domain.</code></li><li>Use <code>geosite:</code> not <code>geosite.</code></li></ul></li><li><p><strong>Review logs</strong> - Enable logs to see which rules are matching</p></li></ol><h3 id="traffic-not-going-through-proxy" tabindex="-1"><a class="header-anchor" href="#traffic-not-going-through-proxy"><span>Traffic Not Going Through Proxy</span></a></h3><p><strong>Symptom</strong>: Sites load but aren&#39;t proxied despite having rules</p><p><strong>Common causes</strong>:</p><ol><li><strong>DNS Bypass is ON</strong> with REDIRECT mode and domain matches FREEDOM</li><li><strong>B/R Policy</strong> doesn&#39;t include the ports being used</li><li><strong>DNS resolution</strong> happening before proxy (check DNS leak prevention)</li><li><strong>QUIC/HTTP3</strong> traffic on UDP 443 not being intercepted</li></ol><p><strong>Solution steps</strong>:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token number">1</span>. Set DNS Bypass to OFF temporarily</span>
<span class="line"><span class="token number">2</span>. Ensure B/R Policy includes both TCP and UDP</span>
<span class="line"><span class="token number">3</span>. Add UDP port <span class="token number">443</span> to your redirect policy</span>
<span class="line"><span class="token number">4</span>. Check logs to verify traffic reaches Xray</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="unexpected-direct-connections" tabindex="-1"><a class="header-anchor" href="#unexpected-direct-connections"><span>Unexpected Direct Connections</span></a></h3><p><strong>Symptom</strong>: Some traffic bypasses proxy without matching any direct rule</p><p><strong>Check</strong>:</p><ol><li><strong>ipset rules</strong> from DNS bypass creating kernel-level bypasses</li><li><strong>System DNS</strong> queries not being intercepted</li><li><strong>IPv6 traffic</strong> if not properly handled</li><li><strong>Cached DNS</strong> responses from before configuration change</li></ol><h3 id="performance-issues" tabindex="-1"><a class="header-anchor" href="#performance-issues"><span>Performance Issues</span></a></h3><p>If routing is slow:</p><ol><li>Reduce regex usage (most resource-intensive)</li><li>Consolidate similar rules</li><li>Use geosite tags instead of listing many domains</li><li>Switch domain matcher to &quot;linear&quot; if accuracy is more important than speed</li></ol><h3 id="debugging-rules" tabindex="-1"><a class="header-anchor" href="#debugging-rules"><span>Debugging Rules</span></a></h3><p>Enable logging to see rule matches:</p><ol><li>Go to <strong>General Options</strong> → <strong>Logs</strong></li><li>Enable <strong>Access logs</strong></li><li>Set <strong>Log level</strong> to &quot;info&quot; or &quot;debug&quot;</li><li>Check logs to see which rules are triggered</li></ol><h3 id="common-mistakes-to-avoid" tabindex="-1"><a class="header-anchor" href="#common-mistakes-to-avoid"><span>Common Mistakes to Avoid</span></a></h3><ul><li><strong>Wrong prefix format</strong>: Use <code>domain:</code> not <code>domain.</code></li><li><strong>Port format confusion</strong>: Use <code>:</code> for ranges (8080:8090), not <code>-</code></li><li><strong>Missing network type</strong>: Specify tcp, udp, or both</li><li><strong>Incorrect rule order</strong>: Catch-all rules placed too early</li><li><strong>Conflicting rules</strong>: Multiple rules matching the same traffic</li></ul><h2 id="quick-reference" tabindex="-1"><a class="header-anchor" href="#quick-reference"><span>Quick Reference</span></a></h2><h3 id="domain-prefixes" tabindex="-1"><a class="header-anchor" href="#domain-prefixes"><span>Domain Prefixes</span></a></h3><table><thead><tr><th>Prefix</th><th>Matches</th><th>Example</th></tr></thead><tbody><tr><td><code>domain:</code></td><td>Domain and all subdomains</td><td><code>domain:google.com</code> matches <code>maps.google.com</code></td></tr><tr><td><code>full:</code></td><td>Exact domain only</td><td><code>full:google.com</code> matches only <code>google.com</code></td></tr><tr><td><code>keyword:</code></td><td>Contains keyword</td><td><code>keyword:google</code> matches <code>googleplex.com</code></td></tr><tr><td><code>regexp:</code></td><td>Regular expression</td><td><code>regexp:.*\\.edu$</code> matches <code>.edu</code> domains</td></tr><tr><td><code>geosite:</code></td><td>Geosite database</td><td><code>geosite:netflix</code></td></tr><tr><td><code>ext:xrayui:</code></td><td>Custom xrayui lists</td><td><code>ext:xrayui:mylist</code></td></tr></tbody></table><h2 id="configuration-decision-tree" tabindex="-1"><a class="header-anchor" href="#configuration-decision-tree"><span>Configuration Decision Tree</span></a></h2><p>When setting up routing in xrayui, follow this decision tree:</p><div class="language-plain line-numbers-mode" data-highlighter="prismjs" data-ext="plain"><pre><code class="language-plain"><span class="line">1. How much traffic needs proxying?</span>
<span class="line">   ├─ Most traffic → DNS Bypass OFF</span>
<span class="line">   └─ Selective → DNS Bypass ON</span>
<span class="line">       ├─ Proxy specific sites → REDIRECT mode</span>
<span class="line">       └─ Bypass specific sites → BYPASS mode</span>
<span class="line"></span>
<span class="line">2. Which devices need proxying?</span>
<span class="line">   ├─ All devices → B/R Policy: Redirect all</span>
<span class="line">   └─ Specific devices → B/R Policy: By MAC/IP</span>
<span class="line"></span>
<span class="line">3. What ports to intercept?</span>
<span class="line">   ├─ Web only → TCP/UDP 80,443</span>
<span class="line">   ├─ All traffic → All ports</span>
<span class="line">   └─ Custom apps → Specific port ranges</span>
<span class="line"></span>
<span class="line">4. How complex is routing?</span>
<span class="line">   ├─ Simple (proxy/direct) → Basic rules</span>
<span class="line">   ├─ By service → Use geosite categories</span>
<span class="line">   └─ Complex logic → Multiple rule layers</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h2><p>Effective routing in xrayui requires understanding three layers:</p><h3 id="layer-1-b-r-policies" tabindex="-1"><a class="header-anchor" href="#layer-1-b-r-policies"><span>Layer 1: B/R Policies</span></a></h3><p>Controls which devices and ports are intercepted by the system.</p><h3 id="layer-2-dns-bypass" tabindex="-1"><a class="header-anchor" href="#layer-2-dns-bypass"><span>Layer 2: DNS Bypass</span></a></h3><p>Pre-filters traffic before Xray, improving performance but reducing control.</p><h3 id="layer-3-xray-routing-rules-1" tabindex="-1"><a class="header-anchor" href="#layer-3-xray-routing-rules-1"><span>Layer 3: Xray Routing Rules</span></a></h3><p>Fine-grained control over traffic that reaches Xray.</p><p><strong>Key concepts to remember:</strong></p><ul><li>Not all traffic automatically goes through Xray</li><li>DNS Bypass can prevent rules from being evaluated</li><li>Rule order matters (first match wins)</li><li>Geosite categories simplify domain management</li><li>Different domain prefixes serve different purposes</li><li>Performance and control are often trade-offs</li></ul><p><strong>Best practices:</strong></p><ol><li>Start with DNS Bypass OFF to understand traffic flow</li><li>Use geosite categories instead of listing individual domains</li><li>Test rules incrementally</li><li>Monitor logs during initial setup</li><li>Optimize with DNS Bypass once routing works correctly</li><li>Document complex configurations</li></ol><div class="hint-container note"><p class="hint-container-title">Note</p><p>Remember to click <strong>Apply</strong> on the main page after making any configuration changes to activate your new routing setup.</p></div>`,197))])}const x=c(m,[["render",b]]),w=JSON.parse('{"path":"/en/routing.html","title":"Routing Rules Guide","lang":"en-US","frontmatter":{},"git":{"updatedTime":1761350718000,"contributors":[{"name":"Daniel Lavrushin","username":"","email":"lavrushin@gmail.com","commits":1}],"changelog":[{"hash":"198f5dcc71b58fcec3c0f1f2ab3ac9a636f56216","time":1761350718000,"email":"lavrushin@gmail.com","author":"Daniel Lavrushin","message":"Add Russian documentation for routing rules and v2dat usage in XRAYUI"}]},"filePathRelative":"en/routing.md"}');export{x as comp,w as data};
