# Менеджер файлов геоданных

XRAYUI предоставляет встроенную систему управления геоданными, позволяющую работать с двумя видами данных:

- **Публичные геоданные** — готовые базы `geosite.dat` и `geoip.dat`, поддерживаемые сообществом, содержащие тысячи категоризированных доменов и диапазонов IP-адресов.
- **Пользовательские геоданные** — ваши собственные списки доменов, компилируемые в бинарный формат Xray и используемые в правилах маршрутизации как `ext:xrayui:{тег}`.

![раздел геоданных](../.vuepress/public/images/custom-geodata/20250902212115.png)

## Публичные геоданные

### Что такое файлы публичных геоданных?

Xray использует две основные базы геоданных:

| Файл | Расположение | Назначение |
|------|-------------|------------|
| `geosite.dat` | `/opt/sbin/geosite.dat` | Категории доменов (`geosite:google`, `geosite:netflix` и т.д.) |
| `geoip.dat` | `/opt/sbin/geoip.dat` | Диапазоны IP по странам (`geoip:cn`, `geoip:us`, `geoip:private` и т.д.) |

Эти файлы поддерживаются сообществом и регулярно обновляются новыми доменами и диапазонами IP. XRAYUI скачивает их с настраиваемых URL-адресов.

### Источники

XRAYUI включает несколько известных источников геоданных. Вы можете выбрать один из выпадающего списка **Известные геоданные** в разделе Общие параметры → Геоданные или задать произвольные URL:

| Источник | Описание |
|----------|----------|
| [Loyalsoldier](https://github.com/Loyalsoldier/v2ray-rules-dat) | Популярный набор общего назначения (по умолчанию) |
| [RUNET Freedom](https://github.com/ANoNameGroup/russia-v2ray-rules-dat) | Фокус на обходе блокировок в России |
| [Nidelon](https://github.com/Nidelon/ru-block-v2ray-rules) | Российские блокировки |
| [DustinWin](https://github.com/DustinWin/ruleset_geodata) | Правила для Китая |
| [Chocolate4U](https://github.com/chocolate4u/Iran-v2ray-rules) | Правила для Ирана |

### Обновление публичных файлов

#### Обновление вручную

В разделе **Маршрутизация** найдите строку **Метаданные GeoIP/GeoSite** и нажмите **обновить публичные файлы**.

![строка метаданных](../.vuepress/public/images/custom-geodata/20250902215014.png)

XRAYUI скачивает свежие `geosite.dat` и `geoip.dat` с настроенных URL, заменяет существующие файлы, перекомпилирует пользовательские геоданные и перезапускает Xray, если он запущен.

В строке также отображается, сколько дней прошло с последнего обновления.

#### Автоматическое обновление

Включите **Автообновление файлов геоданных** в разделе Общие параметры → Геоданные. Задание cron запускается каждую ночь в **03:00** и выполняет:

1. Скачивание свежих `geosite.dat` и `geoip.dat`
2. Перекомпиляцию всех пользовательских файлов (включая загрузку источников с `url:`)
3. Перезапуск Xray, если запущен

::: tip
Автообновление особенно полезно, когда ваши пользовательские файлы используют источники `url:` — XRAYUI автоматически загрузит актуальные списки доменов.
:::

### Прокси для GitHub

Если GitHub заблокирован или ограничен в вашем регионе, настройте прокси в разделе Общие параметры → Основные → **Прокси для GitHub**. Все загрузки геоданных будут проходить через выбранный прокси.

---

## Пользовательские файлы геоданных

### Обзор

Иногда необходимо маршрутизировать трафик для доменов, которых нет в публичных базах, или объединить определённые домены в собственную категорию. XRAYUI позволяет создавать пользовательские geosite-файлы, которые компилируются в бинарный формат Xray.

Пользовательские файлы хранятся в виде текста в `/opt/share/xrayui/data/` и компилируются в единый бинарный файл `/opt/sbin/xrayui`. Для ссылки на них в правилах используется префикс `ext:xrayui:{тег}`.

Например, можно создать файл с тегом `streaming`:

```text
domain:netflix.com
domain:hulu.com
domain:disneyplus.com
```

И использовать `ext:xrayui:streaming` в правилах маршрутизации для одновременного сопоставления всех этих доменов.

### Синтаксис доменов

Каждая строка в файле — это шаблон домена. Поддерживаемые форматы:

| Префикс | Поведение | Пример |
|---------|-----------|--------|
| `domain:` | Домен и все поддомены (рекомендуется) | `domain:google.com` → `google.com`, `mail.google.com` |
| `full:` | Точное совпадение домена | `full:github.com` → только `github.com` |
| `regexp:` | Регулярное выражение | `regexp:.*\.gov` |
| `keyword:` | Содержит подстроку | `keyword:bank` → любой домен, содержащий "bank" |
| `url:` | Загрузка доменов по внешней ссылке | `url:https://example.com/domains.lst` |
| _(простой текст)_ | Поиск по подстроке | `example` → любой домен, содержащий "example" |

::: tip Рекомендуемый префикс
Используйте `domain:` для большинства записей. Он сопоставляет домен и все поддомены — это наиболее типичный сценарий.
:::

### Префикс `url:`

Префикс `url:` — мощная функция, специфичная для XRAYUI. Вместо ручного перечисления доменов вы указываете ссылку на онлайн-список. DatBuilder загружает содержимое по URL и включает его в скомпилированные геоданные.

```text
url:https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/inside-raw.lst
domain:custom-domain.com
```

Можно использовать несколько записей `url:` в одном файле. Каждая должна быть на отдельной строке. Допускается смешивание `url:` с обычными шаблонами доменов.

::: tip Динамические списки
В сочетании с [Автообновлением файлов геоданных](general-options#автообновление-фаилов-геоданных) префикс `url:` позволяет создавать динамические списки доменов, которые обновляются автоматически.
:::

---

## Управление файлами через интерфейс

### Открытие менеджера

В разделе **Маршрутизация** нажмите **лок. файлы** в строке **Метаданные GeoIP/GeoSite**.

![кнопка управления](../.vuepress/public/images/custom-geodata/20250902215014.png)

Откроется модальное окно **Менеджер файлов геоданных**:

![окно менеджера](../.vuepress/public/images/custom-geodata/20250902215154.png)
![окно менеджера](../.vuepress/public/images/custom-geodata/20250902215215.png)

### Создание нового файла

1. Выберите **Создать новый файл** в выпадающем списке
2. Введите **Тег** — идентификатор, который будет использоваться в правилах маршрутизации
3. Добавьте шаблоны доменов в поле **Содержание** (по одному на строку)
4. Нажмите **компилировать**

![редактирование](../.vuepress/public/images/custom-geodata/20250902215347.png)

::: info Ссылка на тег
После создания файла обратите внимание на жёлтый ярлык `ext:xrayui:{тег}` рядом с выпадающим списком. Скопируйте его для использования в правилах маршрутизации.
:::

### Редактирование существующего файла

1. Выберите файл из выпадающего списка
2. Измените содержимое в текстовом поле
3. Нажмите **компилировать** для сохранения и перекомпиляции

### Удаление файла

1. Выберите файл из выпадающего списка
2. Нажмите **удалить**
3. Подтвердите удаление

Файл удаляется из `/opt/share/xrayui/data/`, и все оставшиеся файлы перекомпилируются.

### Перекомпилировать всё

Нажмите **перекомпилировать всё** (видна, когда файл не выбран) для пересборки всех файлов из `/opt/share/xrayui/data/`. Полезно, когда файлы были загружены на роутер напрямую (см. ниже).

> [!note]
> Каждая операция компиляции или перекомпиляции автоматически перезапускает Xray, если он запущен, чтобы новые геоданные вступили в силу немедленно.

---

## Загрузка больших списков доменов

Веб-интерфейс имеет ограничение примерно в **8000 символов** на файл из-за ограничений прошивки Merlin. Для более крупных списков загружайте файлы напрямую на роутер.

### Порядок действий

1. Создайте текстовый файл **без расширения** (например, `mydomains`), по одному шаблону домена на строку
2. Загрузите его в `/opt/share/xrayui/data/` на роутере (через SCP, SFTP или SSH)

   ```bash
   scp mydomains admin@router:/opt/share/xrayui/data/
   ```

3. Откройте **Менеджер файлов геоданных** и нажмите **перекомпилировать всё**

Файл появится в выпадающем списке, и вы сможете использовать `ext:xrayui:mydomains` в правилах маршрутизации.

> [!tip]
> Файлы, загруженные напрямую, не имеют ограничения по размеру. Это рекомендуемый метод для списков из сотен или тысяч доменов.

---

## Использование геоданных в правилах маршрутизации

После компиляции файлов ссылайтесь на них в правилах маршрутизации с соответствующим префиксом.

### Пользовательские теги

```text
ext:xrayui:streaming
ext:xrayui:mydomains
```

### Категории публичных geosite

```text
geosite:google
geosite:netflix
geosite:category-ads-all
```

### Категории GeoIP

```text
geoip:cn
geoip:us
geoip:private
```

Редактор правил предоставляет автозаполнение для тегов `geosite:` и `ext:xrayui:`:

![автозаполнение правил](../.vuepress/public/images/custom-geodata/20250902215117.png)

Подробности о правилах маршрутизации см. в [Правила маршрутизации](routing).

---

## Расположение файлов

| Путь | Описание |
|------|----------|
| `/opt/sbin/geosite.dat` | Публичная база geosite |
| `/opt/sbin/geoip.dat` | Публичная база geoip |
| `/opt/sbin/xrayui` | Скомпилированные пользовательские геоданные (бинарный файл) |
| `/opt/share/xrayui/data/` | Исходные файлы пользовательских геоданных (текстовые) |
| `/opt/share/xrayui/geodata_tags.json` | Кэшированный список всех доступных тегов |
| `/opt/share/xrayui/v2dat` | Инструмент для просмотра тегов |
| `/opt/share/xrayui/xraydatbuilder` | Инструмент компиляции |

---

## Справка по настройкам

Эти параметры доступны в разделе Общие параметры → вкладка **Геоданные**:

| Параметр | Описание | По умолчанию |
|----------|----------|-------------|
| **URL GeoIP dat** | URL для скачивания `geoip.dat` | Релиз Loyalsoldier |
| **URL GeoSite dat** | URL для скачивания `geosite.dat` | Релиз Loyalsoldier |
| **Известные геоданные** | Быстрый выбор URL из проверенного источника | — |
| **Автообновление файлов геоданных** | Включить ежедневное задание cron в 03:00 | Выключено |

Подробности см. в [Общие параметры → Геоданные](general-options#geodata).

---

## Просмотр геоданных

Используйте CLI-инструмент `v2dat` для просмотра тегов, извлечения списков доменов и отладки маршрутизации. Полную инструкцию см. в [Инспекция баз данных Geosite и GeoIP](v2dat).

Краткие примеры:

```bash
# Показать все категории geosite
/opt/share/xrayui/v2dat unpack geosite -t /opt/sbin/geosite.dat

# Просмотреть домены в категории
/opt/share/xrayui/v2dat unpack geosite -p -f netflix /opt/sbin/geosite.dat

# Проверить пользовательскую компиляцию
/opt/share/xrayui/v2dat unpack geosite -t /opt/sbin/xrayui
/opt/share/xrayui/v2dat unpack geosite -p -f streaming /opt/sbin/xrayui
```

---

## Устранение неполадок

### Пользовательский тег не найден в правилах маршрутизации

- Откройте Менеджер файлов геоданных и убедитесь, что файл есть в списке
- Нажмите **перекомпилировать всё** для принудительной пересборки
- Проверьте наличие скомпилированного файла: `ls -la /opt/sbin/xrayui`
- Проверьте тег через v2dat: `/opt/share/xrayui/v2dat unpack geosite -t /opt/sbin/xrayui`

### Ошибка компиляции

- Убедитесь, что содержимое файла имеет корректный синтаксис (один шаблон на строку)
- Проверьте, что файл не пустой — компилятору нужна хотя бы одна запись
- Проверьте логи XRAYUI (включите отладочные логи в Общих параметрах при необходимости)

### Источники `url:` не обновляются

- Проверьте доступность URL с роутера: `curl -I <url>` через SSH
- Если используются URL GitHub, убедитесь, что настроен прокси при блокировке GitHub
- Включите **Автообновление файлов геоданных** для автоматического обновления источников `url:`

### Ошибка обновления публичных геоданных

- Проверьте подключение роутера к интернету
- Проверьте URL для скачивания в разделе Общие параметры → Геоданные
- Если GitHub заблокирован, настройте **Прокси для GitHub** в разделе Общие параметры → Основные
- Попробуйте обновить вручную через SSH: `curl -L <geosite_url> -o /opt/sbin/geosite.dat`
