<!DOCTYPE html>
<html lang="en">
  <head>
    <!--page:xrayui-->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <link rel="shortcut icon" href="images/favicon.png" />
    <link rel="icon" href="images/favicon.png" />
    <title>X-RAY Server</title>
    <link rel="stylesheet" type="text/css" href="index_style.css" />
    <link rel="stylesheet" type="text/css" href="form_style.css" />
    <link rel="stylesheet" type="text/css" href="/js/table/table.css" />

    <script language="JavaScript" type="text/javascript" src="/js/jquery.js"></script>
    <script language="JavaScript" type="text/javascript" src="/js/httpApi.js"></script>
    <script language="JavaScript" type="text/javascript" src="/state.js"></script>
    <script language="JavaScript" type="text/javascript" src="/general.js"></script>
    <script language="JavaScript" type="text/javascript" src="/popup.js"></script>
    <script language="JavaScript" type="text/javascript" src="/help.js"></script>
    <script language="JavaScript" type="text/javascript" src="/validator.js"></script>
    <script>
      var xray = {
        mode: 'standalone',
        router: {
          name: '<% nvram_get("productid"); %>',
          cpu: JSON.parse('<%cpu_core_num();%>'),
          firmware: '<% nvram_get("firmver"); %>',
          language: '<% nvram_get("preferred_lang"); %>',
          ip: '<% nvram_get("lan_ipaddr"); %>',
          territory: '<% nvram_get("territory_code"); %>',
          devices_online: JSON.parse(`<% get_clientlist(); %>`),
          devices: JSON.parse(`<% get_all_basic_clientlist(); %>`),
          wan_ip: '<% nvram_get("wan_ipaddr"); %>',
          wan_connected: '<% nvram_get("link_internet"); %>' == '2'
        },
        server: {
          isRunning: parseInt('<% sysinfo("pid.xray"); %>') > 0
        }
      };
      let custom_settings = `<% get_custom_settings(); %>`;

      try {
        xray.custom_settings = JSON.parse(custom_settings);
      } catch (e) {
        if (custom_settings.indexOf('xray_payload') !== -1) {
          console.error("Invalid custom settings: xray_payload detected. Please  run '/jffs/scripts/xrayui fixme'. This is unexpected, please report.");
        }
      }
      document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.show_menu === 'function') {
          window.show_menu();
        }
      });
      function handleAppMessage(e) {
        const iframe = document.getElementById('xrayui-iframe');
        if (e.data.action == 'resize-iframe') {
          console.log('Received message from app:', e.data);
          iframe.style.width = e.data.width + 'px';
          iframe.style.height = e.data.height + 'px';
        }
      }
      window.addEventListener('message', handleAppMessage, false);
    </script>
  </head>

  <body>
    <div id="TopBanner"></div>
    <div id="Loading" class="popup_bg"></div>

    <form method="post" name="form" id="ruleForm" action="/start_apply.htm" target="hidden_frame">
      <input type="hidden" name="current_page" :value="page" />
      <input type="hidden" name="next_page" :value="page" />
      <input type="hidden" name="group_id" value="" />
      <input type="hidden" name="modified" value="0" />
      <input type="hidden" name="action_mode" value="apply" />
      <input type="hidden" name="action_wait" value="5" />
      <input type="hidden" name="first_time" value="" />
      <input type="hidden" name="action_script" value="" />
      <input type="hidden" name="amng_custom" value="" />
      <table class="content" align="center" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td width="17">&nbsp;</td>
            <td valign="top" width="202">
              <div id="mainMenu"></div>
              <div id="subMenu"></div>
            </td>
            <td valign="top">
              <div id="tabMenu" class="submenuBlock"></div>
              <table width="98%" border="0" align="left" cellpadding="0" cellspacing="0">
                <tbody>
                  <tr>
                    <td valign="top">
                      <table width="760px" border="0" cellpadding="4" cellspacing="0" id="FormTitle" class="FormTitle">
                        <tbody>
                          <tr bgcolor="#4D595D">
                            <td valign="top">
                              <iframe id="xrayui-iframe" src="http://localhost:18088/index.html" style="border: 0"></iframe>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
    </form>
    <div id="footer"></div>
  </body>
</html>
